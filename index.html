
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard Lead Immobiliare (Offline)</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">

  <style>
    :root{
      --bg:#0b1120; --text:#f3f4f6; --muted:#a0adb8; --gold:#d8a23a;
      --success:#10b981; --error:#ef4444; --warning:#f59e0b; --info:#3b82f6;
      --border: rgba(225,225,225,0.18);
      --shadow: 0 14px 50px rgba(0,0,0,0.45);
      --radius: 18px;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg: #f8fafc; --text: #1e293b; --muted: #64748b; --gold: #b45309;
        --border: rgba(0,0,0,0.12);
        --shadow: 0 14px 50px rgba(0,0,0,0.08);
      }
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    :focus-visible{ outline:2px solid var(--gold); outline-offset:2px; }
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(216,162,58,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(123,79,189,.14), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(74,143,114,.14), transparent 55%),
        var(--bg);
      transition: background-color 0.3s ease;
    }
    @media (prefers-color-scheme: light) {
      body{
        background:
          radial-gradient(900px 500px at 15% 10%, rgba(216,162,58,.08), transparent 60%),
          radial-gradient(900px 600px at 85% 30%, rgba(123,79,189,.06), transparent 55%),
          radial-gradient(900px 600px at 70% 85%, rgba(74,143,114,.06), transparent 55%),
          var(--bg);
      }
    }
    .wrap{max-width:1150px;margin:0 auto;padding:14px 12px 96px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:950;
      letter-spacing:.2px;
      font-size:11px;
      line-height:1;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease, border-color .14s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .btn:focus-visible{ outline:2px solid var(--gold); outline-offset:2px; }
    .btn:hover{transform: translateY(-2px) scale(1.01);border-color: rgba(216,162,58,.22);box-shadow: 0 14px 34px rgba(0,0,0,.30);filter: brightness(1.06);}
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn.primary{background: linear-gradient(135deg, rgba(216,162,58,.95), rgba(216,162,58,.72));color:#111;border-color: rgba(216,162,58,.55);}
    .btn.blue{background: linear-gradient(135deg, rgba(57,90,140,.95), rgba(57,90,140,.70));border-color: rgba(57,90,140,.55);}
    .btn.violet{background: linear-gradient(135deg, rgba(123,79,189,.95), rgba(123,79,189,.70));border-color: rgba(123,79,189,.55);}
    .btn.danger{background: linear-gradient(135deg, rgba(180,64,64,.92), rgba(180,64,64,.66));border-color: rgba(180,64,64,.55);}
    .btn.success{background: linear-gradient(135deg, rgba(16,185,129,.92), rgba(16,185,129,.66));border-color: rgba(16,185,129,.55);}
    .btn.gray{background: rgba(255,255,255,.04);}
    .btn.tiny{padding:6px 9px;font-size:10px;border-radius:11px;box-shadow:none}
    .btn.loading{opacity:0.7;cursor:wait;position:relative;}
    .btn.loading::after{content:"";position:absolute;right:8px;width:12px;height:12px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.6s linear infinite;}

    .pill{
      font-size:10px;color:var(--muted);padding:6px 10px;border:1px solid var(--border);
      border-radius:999px;background:rgba(0,0,0,.18);font-weight:900;letter-spacing:.2px;
      display:inline-flex;gap:8px;align-items:center;white-space:nowrap;
    }
    @media (prefers-color-scheme: light) { .pill{background:rgba(255,255,255,.5);} }
    .pill.warn{border-color: rgba(216,162,58,.45); box-shadow: 0 0 0 6px rgba(216,162,58,.10);}
    .pill.bad{border-color: rgba(220,110,110,.55); box-shadow: 0 0 0 6px rgba(220,110,110,.10);}
    .pill.info{border-color: rgba(59,130,246,.55); box-shadow: 0 0 0 6px rgba(59,130,246,.10);}
    .hintTop{margin: 6px 0 10px;font-size:11px;color: var(--muted);line-height: 1.35;}
    .layout{display:grid;grid-template-columns: 1fr 380px;gap:12px;align-items:start;margin-top:12px}
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      transition: all 0.3s ease;
    }
    @media (prefers-color-scheme: light) {
      .card{background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.7));}
    }
    .section{padding:12px}
    .section + .section{border-top:1px solid rgba(255,255,255,.10)}
    .h{margin:0 0 8px;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;font-weight:950}

    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18); color:var(--text);
      outline:none; font-weight:850; font-size:12px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    @media (prefers-color-scheme: light) {
      input, select, textarea{background:rgba(255,255,255,.7);border-color:rgba(0,0,0,.12);}
    }
    textarea{resize:vertical;min-height:90px;line-height:1.25}
    input:focus, select:focus, textarea:focus, input:focus-visible, select:focus-visible, textarea:focus-visible{
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 980px){ .grid2{ grid-template-columns:1fr; } }

    .mini{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px;
      transition: all 0.3s ease;
    }
    @media (prefers-color-scheme: light) { .mini{background:rgba(255,255,255,.7);border-color:rgba(0,0,0,.12);} }

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.14);
      padding:10px;
      transition: all 0.3s ease;
    }
    @media (prefers-color-scheme: light) { .item{background:rgba(255,255,255,.5);border-color:rgba(0,0,0,.08);} }
    .item b{font-size:12px}
    .subtle{font-size:11px;color:var(--muted);line-height:1.35;margin-top:6px}
    .bottomBar{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      display:flex; justify-content:space-between; align-items:center; gap:10px; z-index: 50;
      flex-wrap:wrap;
      transition: all 0.3s ease;
    }
    @media (prefers-color-scheme: light) {
      .bottomBar{background:rgba(255,255,255,.9);border-color:rgba(0,0,0,.08);}
    }

    .kpis{display:flex;gap:8px;flex-wrap:wrap}
    .kpi{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      border-radius:14px;
      padding:8px 10px;
      min-width:160px;
      transition: all 0.3s ease;
    }
    @media (prefers-color-scheme: light) { .kpi{background:rgba(255,255,255,.5);border-color:rgba(0,0,0,.08);} }
    .kpi .t{font-size:10px;color:var(--muted);font-weight:950;letter-spacing:.6px;text-transform:uppercase}
    .kpi .v{font-size:16px;font-weight:1000;margin-top:4px}
    .kpi .s{font-size:11px;color:var(--muted);margin-top:2px}

    dialog{
      border:1px solid rgba(255,255,255,.16);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.35));
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 760px;
      width: calc(100% - 18px);
      transition: all 0.3s ease;
    }
    @media (prefers-color-scheme: light) {
      dialog{background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.8));}
    }
    dialog::backdrop{
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
    }
    .dlgHead{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .dlgTitle{font-size:12px;font-weight:1000;color:var(--muted);letter-spacing:.8px;text-transform:uppercase}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:10px 0}

    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      font-size:10px; color: var(--muted); font-weight:950;
      margin-right:6px; margin-top:6px;
      transition: all 0.3s ease;
    }
    @media (prefers-color-scheme: light) { .tag{background:rgba(255,255,255,.7);border-color:rgba(0,0,0,.12);} }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 350px;
    }
    .toast {
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(0,0,0,.85);
      color: white;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(8px);
    }
    .toast-success { border-color: var(--success); }
    .toast-error { border-color: var(--error); }
    .toast-warning { border-color: var(--warning); }
    .toast-info { border-color: var(--info); }
    .toast-close {
      margin-left: auto;
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      opacity: 0.7;
    }
    .toast-close:hover { opacity: 1; }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid transparent;
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Chart container */
    .chart-container {
      margin-top: 15px;
      padding: 15px;
      background: rgba(0,0,0,.1);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
    }
    @media (prefers-color-scheme: light) {
      .chart-container{background:rgba(255,255,255,.5);border-color:rgba(0,0,0,.08);}
    }
    .chart-bar {
      height: 20px;
      background: linear-gradient(90deg, var(--gold), rgba(216,162,58,.7));
      border-radius: 4px;
      margin-bottom: 8px;
      transition: width 0.5s ease;
    }
    .chart-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
    }
    [data-tooltip]:before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 10px;
      background: rgba(0,0,0,.9);
      color: white;
      font-size: 11px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    [data-tooltip]:hover:before {
      opacity: 1;
    }

    /* Animations */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Responsive tweaks */
    @media (max-width: 768px) {
      .wrap { padding: 10px 8px 80px; }
      .card { margin-bottom: 10px; }
      .kpi { min-width: 140px; }
      .toast-container {
        left: 10px;
        right: 10px;
        max-width: none;
      }
    }
    @media (max-width: 480px) {
      header .row { flex-direction: column; align-items: flex-start; }
      .kpis { flex-direction: column; }
      .kpi { min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOP -->
    <header>
      <div class="row" style="flex:1;">
        <button class="btn primary" id="btnScrollAction" type="button" data-tooltip="Vai al form azioni">‚ûï Azione</button>
        <button class="btn blue" id="btnScrollConv" type="button" data-tooltip="Vai al form conversazioni">üß© Conversazione</button>
        <button class="btn violet" id="btnExportCSV" type="button" data-tooltip="Esporta dati in CSV">üìÑ Export CSV</button>

        <span class="pill" id="connectionStatus" data-tooltip="Stato connessione">
          <span id="metaActions">Azioni: 0</span><span>‚Ä¢</span>
          <span id="metaConvs">Conversazioni: 0</span><span>‚Ä¢</span>
          <span id="metaToday">Oggi: ‚Äî</span>
        </span>
      </div>

      <div class="row">
        <button class="btn tiny gray" id="btnHelp" type="button" data-tooltip="Istruzioni d\'uso">üìò Istruzioni</button>
        <button class="btn tiny gray" id="btnInstall" type="button" data-tooltip="Installa come app" style="display:none">‚¨áÔ∏è Installa</button>
        <button class="btn tiny gray" id="btnBackup" type="button" data-tooltip="Crea backup JSON">üßæ Backup JSON</button>
        <label class="btn tiny gray" style="cursor:pointer;" data-tooltip="Importa dati da JSON">
          üì• Import JSON
          <input id="fileImport" type="file" accept="application/json" style="display:none;">
        </label>
        <button class="btn tiny danger" id="btnReset" type="button" data-tooltip="Reset totale dati">üóëÔ∏è Reset</button>
      </div>
    </header>

    <div class="hintTop">
      Offline: dati salvati nel <b>browser</b> (LocalStorage). Usa <b>Backup JSON</b> per sicurezza e <b>Export CSV</b> per Excel.
      <br/>Migliorie incluse: <b>tag</b>, <b>filtri</b>, <b>modifica/elimina</b>, <b>PWA</b>, <b>grafici</b>, <b>backup automatico</b>.
    </div>

    <div class="layout">
      <!-- MAIN -->
      <div class="card">

        <div class="section">
          <p class="h">Oggi</p>

          <div class="kpis">
            <div class="kpi">
              <div class="t">Minuti oggi</div>
              <div class="v" id="kpiMinutesToday">‚Äî</div>
              <div class="s" id="kpiMinutesTodaySub">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="t">Follow-up scaduti</div>
              <div class="v" id="kpiOverdue">‚Äî</div>
              <div class="s">Esclusi: incarico/persa</div>
            </div>
            <div class="kpi">
              <div class="t">Follow-up oggi</div>
              <div class="v" id="kpiDueToday">‚Äî</div>
              <div class="s">Da ricontattare oggi</div>
            </div>
            <div class="kpi">
              <div class="t">Spazio dati</div>
              <div class="v" id="kpiStorage">‚Äî</div>
              <div class="s" id="kpiStorageSub">‚Äî</div>
            </div>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div>
              <div class="subtle">Azioni di oggi</div>
              <div class="mini" id="actionsTodayBox">‚Äî</div>
              <div class="row" style="margin-top:10px;">
                <button class="btn tiny gray" id="btnEditLastAction" type="button" data-tooltip="Modifica l'ultima azione registrata">‚úèÔ∏è Modifica ultima</button>
                <button class="btn tiny danger" id="btnDeleteLastAction" type="button" data-tooltip="Elimina l'ultima azione">üóëÔ∏è Elimina ultima</button>
              </div>
            </div>
            <div>
              <div class="subtle">Follow-up in scadenza</div>
              <div class="mini" id="followupsBox">‚Äî</div>
              <div id="followupsList" class="list" style="margin-top:10px;"></div>
            </div>
          </div>

          <div id="chartSection" class="chart-container" style="display:none;">
            <div class="h">Andamento settimanale (minuti)</div>
            <div id="weeklyChart"></div>
          </div>
        </div>

        <div class="section" id="secAction">
          <p class="h">Registra azione</p>
          <div class="grid2">
            <div>
              <label class="subtle">Data</label>
              <input id="a_when" type="date" required/>
            </div>
            <div>
              <label class="subtle">Canale</label>
              <select id="a_channel" required></select>
            </div>
          </div>
          <div class="grid2" style="margin-top:10px;">
            <div>
              <label class="subtle">Minuti (1-480)</label>
              <input id="a_minutes" type="number" min="1" max="480" value="30" required/>
            </div>
            <div>
              <label class="subtle">Nota</label>
              <input id="a_note" placeholder="Es. Commenti in gruppi zona X" maxlength="500"/>
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btnAddAction" type="button" data-tooltip="Salva azione (Ctrl+S)">‚úÖ Salva azione</button>
            <span class="pill" id="actionMsg" style="display:none;">OK</span>
          </div>
        </div>

        <div class="section" id="secConv">
          <p class="h">Registra conversazione</p>
          <div class="grid2">
            <div>
              <label class="subtle">Nome *</label>
              <input id="c_name" placeholder="Es. Mario R." required maxlength="100"/>
            </div>
            <div>
              <label class="subtle">Citt√†/Zona *</label>
              <input id="c_zone" placeholder="Es. Roma - Prati" required maxlength="100"/>
            </div>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div>
              <label class="subtle">Origine</label>
              <input id="c_origin" placeholder="Es. FB gruppo X / IG / SEO" maxlength="100"/>
            </div>
            <div>
              <label class="subtle">Stato *</label>
              <select id="c_stage" required></select>
            </div>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div>
              <label class="subtle">Follow-up</label>
              <input id="c_follow" type="date"/>
            </div>
            <div>
              <label class="subtle">Tag (virgole, max 30)</label>
              <input id="c_tags" placeholder="es. urgente, prima casa, investitore" maxlength="200"/>
            </div>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div>
              <label class="subtle">Telefono (opz.)</label>
              <input id="c_phone" placeholder="+39 ..." pattern="^[\d\s\-\+\(\)]+$" title="Solo numeri, spazi, +, -, ( )"/>
            </div>
            <div>
              <label class="subtle">Email (opz.)</label>
              <input id="c_email" type="email" placeholder="nome@email.it"/>
            </div>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div>
              <label class="subtle">Nota breve</label>
              <input id="c_note_short" placeholder="Opzionale" maxlength="200"/>
            </div>
            <div>
              <label class="subtle">Link (opz.)</label>
              <input id="c_link" placeholder="Annuncio / chat / documento..." type="url"/>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label class="subtle">Note dettagliate</label>
            <textarea id="c_note" placeholder="Dettagli utili..." maxlength="2000"></textarea>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn blue" id="btnAddConv" type="button" data-tooltip="Salva conversazione (Ctrl+Shift+S)">‚úÖ Salva conversazione</button>
            <span class="pill" id="convMsg" style="display:none;">OK</span>
          </div>
        </div>
      </div>

      <!-- SIDE -->
      <div class="card">
        <div class="section">
          <p class="h">Report settimana</p>
          <div class="mini" id="reportBox">‚Äî</div>
          <button class="btn tiny gray" id="btnToggleChart" type="button" style="margin-top:10px;">üìä Mostra grafico</button>
        </div>

        <div class="section">
          <p class="h">Filtri lead</p>
          <div class="grid2">
            <div>
              <label class="subtle">Stato</label>
              <select id="f_stage">
                <option value="">Tutti</option>
              </select>
            </div>
            <div>
              <label class="subtle">Follow-up</label>
              <select id="f_due">
                <option value="">Tutti</option>
                <option value="overdue">Scaduti</option>
                <option value="today">Oggi</option>
                <option value="next7">Prossimi 7 giorni</option>
                <option value="none">Senza follow-up</option>
              </select>
            </div>
          </div>
          <div style="margin-top:10px;">
            <label class="subtle">Tag contiene</label>
            <input id="f_tag" placeholder="es. urgente"/>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn gray" id="btnApplyFilters" type="button" data-tooltip="Applica filtri">üéõÔ∏è Applica</button>
            <button class="btn tiny gray" id="btnResetFilters" type="button">Reset</button>
          </div>
          <div class="subtle" style="margin-top:10px;">Risultati filtrati (<span id="filterCount">0</span>)</div>
          <div id="filterResults" class="list" style="margin-top:8px; max-height:400px; overflow-y:auto;"></div>
        </div>

        <div class="section">
          <p class="h">Ricerca</p>
          <input id="q" placeholder="Cerca nome / zona / origine / note / tag"/>
          <div class="row" style="margin-top:10px;">
            <button class="btn gray" id="btnSearch" type="button">üîé Cerca</button>
            <button class="btn tiny gray" id="btnClearSearch" type="button">Svuota</button>
          </div>
          <div class="subtle" style="margin-top:10px;">Risultati (<span id="searchCount">0</span>)</div>
          <div id="searchResults" class="list" style="margin-top:8px; max-height:300px; overflow-y:auto;"></div>
        </div>

        <div class="section">
          <p class="h">Note operative</p>
          <div class="subtle">
            Per trasferire dati su un altro PC: <b>Backup JSON</b> ‚Üí <b>Import JSON</b>.<br/>
            Per Excel: usa <b>Export CSV</b>.<br/>
            Tip: fai backup periodici (es. ogni fine settimana).<br/>
            <span id="lastBackupInfo" style="font-size:10px;"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottomBar">
    <span class="pill" id="statusPill">Offline ‚Ä¢ LocalStorage ‚Ä¢ Export CSV/JSON ‚Ä¢ PWA</span>
    <div class="row">
      <button class="btn tiny gray" id="btnQuickFiltersOverdue" type="button" data-tooltip="Mostra follow-up scaduti">‚è∞ Scaduti</button>
      <button class="btn tiny gray" id="btnQuickFiltersToday" type="button" data-tooltip="Mostra follow-up oggi">üìÖ Oggi</button>
      <button class="btn tiny gray" id="btnQuickFiltersNext7" type="button" data-tooltip="Prossimi 7 giorni">üóìÔ∏è 7gg</button>
      <button class="btn tiny gray" id="btnQuickAll" type="button" data-tooltip="Mostra tutti">üßº Tutti</button>
      <button class="btn tiny info" id="btnStats" type="button" data-tooltip="Statistiche avanzate">üìä Stats</button>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="loading-spinner"></div>
  </div>

  <!-- DIALOG: EDIT CONVERSATION -->
  <dialog id="dlgConv">
    <form method="dialog" id="dlgConvForm">
      <div class="dlgHead">
        <div class="dlgTitle">Modifica conversazione</div>
        <button class="btn tiny gray" value="cancel" type="submit" data-tooltip="Chiudi (Esc)">‚úñÔ∏è Chiudi</button>
      </div>

      <input type="hidden" id="e_id"/>

      <div class="grid2">
        <div>
          <label class="subtle">Nome *</label>
          <input id="e_name" required maxlength="100"/>
        </div>
        <div>
          <label class="subtle">Citt√†/Zona *</label>
          <input id="e_zone" required maxlength="100"/>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label class="subtle">Origine</label>
          <input id="e_origin" maxlength="100"/>
        </div>
        <div>
          <label class="subtle">Stato *</label>
          <select id="e_stage" required></select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label class="subtle">Follow-up</label>
          <input id="e_follow" type="date"/>
        </div>
        <div>
          <label class="subtle">Tag (virgole)</label>
          <input id="e_tags" maxlength="200"/>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label class="subtle">Telefono</label>
          <input id="e_phone" pattern="^[\d\s\-\+\(\)]+$"/>
        </div>
        <div>
          <label class="subtle">Email</label>
          <input id="e_email" type="email"/>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label class="subtle">Link</label>
          <input id="e_link" type="url"/>
        </div>
        <div>
          <label class="subtle">Ultimo contatto</label>
          <input id="e_last" type="date" disabled/>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="subtle">Note</label>
        <textarea id="e_note" maxlength="2000"></textarea>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;">
        <button class="btn danger" id="btnDeleteConv" type="button" data-tooltip="Elimina conversazione">üóëÔ∏è Elimina</button>
        <div class="row">
          <button class="btn gray" value="cancel" type="submit">Annulla</button>
          <button class="btn blue" id="btnSaveConv" type="button">‚úÖ Salva modifiche</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- DIALOG: EDIT ACTION -->
  <dialog id="dlgAction">
    <form method="dialog" id="dlgActionForm">
      <div class="dlgHead">
        <div class="dlgTitle">Modifica azione</div>
        <button class="btn tiny gray" value="cancel" type="submit" data-tooltip="Chiudi (Esc)">‚úñÔ∏è Chiudi</button>
      </div>

      <input type="hidden" id="ea_id"/>

      <div class="grid2">
        <div>
          <label class="subtle">Data *</label>
          <input id="ea_when" type="date" required/>
        </div>
        <div>
          <label class="subtle">Canale *</label>
          <select id="ea_channel" required></select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label class="subtle">Minuti *</label>
          <input id="ea_minutes" type="number" min="1" max="480" required/>
        </div>
        <div>
          <label class="subtle">Nota</label>
          <input id="ea_note" maxlength="500"/>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;">
        <button class="btn danger" id="btnDeleteAction" type="button" data-tooltip="Elimina azione">üóëÔ∏è Elimina</button>
        <div class="row">
          <button class="btn gray" value="cancel" type="submit">Annulla</button>
          <button class="btn blue" id="btnSaveAction" type="button">‚úÖ Salva modifiche</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- DIALOG: STATISTICS -->
  <dialog id="dlgStats">
    <form method="dialog">
      <div class="dlgHead">
        <div class="dlgTitle">Statistiche avanzate</div>
        <button class="btn tiny gray" value="cancel" type="submit">‚úñÔ∏è Chiudi</button>
      </div>

      <div class="grid2">
        <div>
          <div class="kpi">
            <div class="t">Azioni totali</div>
            <div class="v" id="statTotalActions">0</div>
            <div class="s">Minuti totali: <span id="statTotalMinutes">0</span></div>
          </div>
        </div>
        <div>
          <div class="kpi">
            <div class="t">Conversazioni totali</div>
            <div class="v" id="statTotalConvs">0</div>
            <div class="s">Lead attivi: <span id="statActiveLeads">0</span></div>
          </div>
        </div>
      </div>

      <div style="margin-top:15px;">
        <div class="h">Distribuzione canali (ultimi 30 giorni)</div>
        <div id="statsChannelsChart" class="chart-container"></div>
      </div>

      <div style="margin-top:15px;">
        <div class="h">Pipeline attuale</div>
        <div id="statsPipelineChart" class="chart-container"></div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:flex-end;">
        <button class="btn gray" value="cancel" type="submit">Chiudi</button>
      </div>
    </form>
  </dialog>


  <!-- DIALOG: ISTRUZIONI -->
  <dialog id="dlgHelp">
    <form method="dialog">
      <div class="dlgHead">
        <div class="dlgTitle">Istruzioni d‚Äôuso</div>
        <button class="btn tiny gray" value="cancel" type="submit">‚úñÔ∏è Chiudi</button>
      </div>

      <div class="mini" style="line-height:1.5;">
üìå GUIDA RAPIDA (anche per principianti)

1Ô∏è‚É£ REGISTRA UN‚ÄôAZIONE
- Clicca ‚ûï Azione
- Inserisci data, canale e minuti
- Premi ‚úÖ Salva azione

2Ô∏è‚É£ REGISTRA UN LEAD
- Clicca üß© Conversazione
- Compila Nome, Zona e Stato
- Imposta Follow-up se devi ricontattare
- Premi ‚úÖ Salva conversazione

3Ô∏è‚É£ OGNI GIORNO
- Guarda ‚ÄúFollow-up in scadenza‚Äù
- Usa i pulsanti ‚è∞ Scaduti / üìÖ Oggi / üóìÔ∏è 7gg

4Ô∏è‚É£ TROVA UN CONTATTO
- Usa Ricerca o Filtri per stato, data o tag

5Ô∏è‚É£ NON PERDERE I DATI
- Premi üßæ Backup JSON almeno 1 volta a settimana
- Per Excel usa üìÑ Export CSV
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:flex-end;">
        <button class="btn gray" value="cancel" type="submit">Chiudi</button>
      </div>
    </form>
  </dialog>

<script>
/* =========================
   CONFIG & CONSTANTS
========================= */
const CHANNELS = ["social","gruppi","video","seo","forum"];
const PIPELINE = ["aperta","qualificata","consilenza","incarico","persa"];
const STORAGE_KEY = "dash_immobiliare_v3";
const BACKUP_PREFIX = `${STORAGE_KEY}_backup_`;
const MAX_ACTIONS = 10000;
const MAX_CONVERSATIONS = 5000;

/* =========================
   UTILITY FUNCTIONS
========================= */
const el = (id) => document.getElementById(id);
const pad2 = (n) => String(n).padStart(2,"0");
const todayStr = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};

function parseDateSafe(str) {
  if (!str) return null;
  const match = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!match) return null;
  const [_, year, month, day] = match.map(Number);
  if (year < 2000 || year > 2100 || month < 1 || month > 12 || day < 1 || day > 31) {
    return null;
  }
  const date = new Date(year, month - 1, day);
  return date.getFullYear() === year && 
         date.getMonth() === month - 1 && 
         date.getDate() === day ? date : null;
}

function formatDate(date) {
  if (!date) return "";
  const d = date instanceof Date ? date : parseDateSafe(date);
  if (!d) return "";
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
}

function weekRange(refDate) {
  const d = new Date(refDate);
  const day = d.getDay();
  const mondayOffset = (day === 0 ? -6 : 1 - day);
  const start = new Date(d); start.setDate(d.getDate() + mondayOffset);
  const end = new Date(start); end.setDate(start.getDate() + 6);
  const fmt = (x) => `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
  return {start, end, startStr: fmt(start), endStr: fmt(end)};
}

function downloadFile(filename, content, mime) {
  try {
    const blob = new Blob([content], {type: mime || "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
  } catch (error) {
    showToast(`Errore download: ${error.message}`, "error");
  }
}

function toCSV(rows, headers) {
  const esc = (v) => {
    if (v === null || v === undefined) return "";
    const s = String(v);
    const needs = /[",\n;]/.test(s);
    const safe = s.replace(/"/g, '""');
    return needs ? `"${safe}"` : safe;
  };
  return [
    headers.join(";"),
    ...rows.map(r => headers.map(h => esc(r[h])).join(";"))
  ].join("\n");
}

function normalizeTags(str) {
  return (str||"")
    .split(",")
    .map(t => t.trim().toLowerCase().replace(/\s+/g, "_"))
    .filter(t => t.length > 0 && t.length <= 30)
    .slice(0, 30);
}

function sanitizeInput(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.textContent;
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

/* =========================
   UI UTILITIES
========================= */
function showToast(message, type = "info", duration = 4000) {
  const container = el("toastContainer");
  const toast = document.createElement("div");
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <span>${message}</span>
    <button class="toast-close" aria-label="Chiudi">&times;</button>
  `;
  
  container.appendChild(toast);
  
  toast.querySelector(".toast-close").addEventListener("click", () => {
    toast.remove();
  });
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.style.animation = "slideIn 0.3s ease reverse";
      setTimeout(() => toast.remove(), 300);
    }
  }, duration);
}

function showLoading(show) {
  el("loadingOverlay").style.display = show ? "flex" : "none";
}

function setButtonLoading(button, isLoading) {
  if (isLoading) {
    button.classList.add("loading");
    button.disabled = true;
  } else {
    button.classList.remove("loading");
    button.disabled = false;
  }
}

/* =========================
   VALIDATION FUNCTIONS
========================= */
function validateAction(data) {
  const errors = [];
  if (!CHANNELS.includes(data.channel)) {
    errors.push("Seleziona un canale valido");
  }
  if (!data.minutes || data.minutes < 1 || data.minutes > 480) {
    errors.push("I minuti devono essere tra 1 e 480");
  }
  if (!data.when || !parseDateSafe(data.when)) {
    errors.push("Data non valida");
  }
  return errors;
}

function validateConversation(data) {
  const errors = [];
  if (!data.name?.trim()) {
    errors.push("Il nome √® obbligatorio");
  }
  if (!data.city_zone?.trim()) {
    errors.push("La zona √® obbligatoria");
  }
  if (!PIPELINE.includes(data.stage)) {
    errors.push("Stato non valido");
  }
  if (data.next_followup && !parseDateSafe(data.next_followup)) {
    errors.push("Data follow-up non valida");
  }
  if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
    errors.push("Email non valida");
  }
  if (data.phone && !/^[\d\s\-\+\(\)]+$/.test(data.phone)) {
    errors.push("Telefono non valido");
  }
  return errors;
}

/* =========================
   STORAGE MANAGEMENT
========================= */
function makeInitDB() {
  return {
    version: 3,
    actions: [],
    conversations: [],
    meta: {
      created_at: new Date().toISOString(),
      last_backup: null,
      last_cleanup: null
    }
  };
}

function loadDB() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      const init = makeInitDB();
      saveDB(init);
      return init;
    }
    
    const obj = JSON.parse(raw);
    
    // Migration from older versions
    if (!obj.version || obj.version < 3) {
      obj.version = 3;
      obj.conversations = obj.conversations.map(c => ({
        ...c,
        tags: Array.isArray(c.tags) ? c.tags : normalizeTags(c.tags || ""),
        phone: c.phone || "",
        email: c.email || "",
        link: c.link || "",
        note: c.note || ""
      }));
      obj.meta = obj.meta || makeInitDB().meta;
    }
    
    // Ensure required fields
    if (!Array.isArray(obj.actions)) obj.actions = [];
    if (!Array.isArray(obj.conversations)) obj.conversations = [];
    
    return obj;
  } catch (error) {
    console.error("Error loading DB:", error);
    showToast("Errore caricamento dati, ripristino da backup...", "warning");
    
    // Try to recover from backup
    if (recoverFromBackup()) {
      return loadDB();
    }
    
    const init = makeInitDB();
    saveDB(init);
    return init;
  }
}

function saveDB(db) {
  try {
    // Auto cleanup if needed
    if (db.actions.length > MAX_ACTIONS) {
      db.actions = db.actions.slice(-MAX_ACTIONS);
      db.meta.last_cleanup = new Date().toISOString();
      showToast(`Puliti ${MAX_ACTIONS} azioni pi√π vecchie`, "info");
    }
    
    if (db.conversations.length > MAX_CONVERSATIONS) {
      db.conversations = db.conversations.slice(-MAX_CONVERSATIONS);
      db.meta.last_cleanup = new Date().toISOString();
      showToast(`Pulite ${MAX_CONVERSATIONS} conversazioni pi√π vecchie`, "info");
    }
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    
    // Create backup every 10 saves
    const backupCount = Object.keys(localStorage).filter(k => k.startsWith(BACKUP_PREFIX)).length;
    if (backupCount < 5) {
      createAutoBackup(db);
    }
    
    return true;
  } catch (error) {
    console.error("Error saving DB:", error);
    showToast("Errore salvataggio dati: " + error.message, "error");
    return false;
  }
}

function checkStorageQuota() {
  try {
    const testKey = "_storage_test";
    const testData = "x".repeat(1024 * 1024); // 1MB
    localStorage.setItem(testKey, testData);
    localStorage.removeItem(testKey);
    return { available: true, message: "Spazio sufficiente" };
  } catch (e) {
    return { available: false, message: "Spazio insufficiente" };
  }
}

function createAutoBackup(db) {
  try {
    const backupKey = `${BACKUP_PREFIX}${Date.now()}`;
    localStorage.setItem(backupKey, JSON.stringify(db));
    db.meta.last_backup = new Date().toISOString();
    
    // Keep only last 5 backups
    const backups = Object.keys(localStorage)
      .filter(k => k.startsWith(BACKUP_PREFIX))
      .sort()
      .slice(0, -5);
    
    backups.forEach(k => localStorage.removeItem(k));
    
    return true;
  } catch (error) {
    console.error("Backup failed:", error);
    return false;
  }
}

function recoverFromBackup() {
  try {
    const backups = Object.keys(localStorage)
      .filter(k => k.startsWith(BACKUP_PREFIX))
      .sort()
      .reverse();
    
    for (const key of backups) {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        if (data && Array.isArray(data.actions) && Array.isArray(data.conversations)) {
          localStorage.setItem(STORAGE_KEY, localStorage.getItem(key));
          showToast("Ripristinato da backup automatico", "success");
          return true;
        }
      } catch (e) {
        continue;
      }
    }
    return false;
  } catch (error) {
    console.error("Recovery failed:", error);
    return false;
  }
}

/* =========================
   BUSINESS LOGIC
========================= */
function actionsToday(db, day) {
  return db.actions.filter(a => a.when === day);
}

function followupsAllOpen(db) {
  return db.conversations
    .filter(c => c.stage !== "incarico" && c.stage !== "persa")
    .filter(c => c.next_followup);
}

function followupsByType(db, day, type) {
  const t = parseDateSafe(day);
  if (!t) return [];
  
  const list = followupsAllOpen(db)
    .map(c => ({...c, _d: parseDateSafe(c.next_followup)}))
    .filter(x => x._d)
    .sort((a, b) => (a.next_followup || "").localeCompare(b.next_followup || ""));

  if (type === "overdue") {
    return list.filter(x => x._d < t);
  }
  if (type === "today") {
    const t0 = new Date(t.getFullYear(), t.getMonth(), t.getDate());
    return list.filter(x => {
      const d0 = new Date(x._d.getFullYear(), x._d.getMonth(), x._d.getDate());
      return d0.getTime() === t0.getTime();
    });
  }
  if (type === "next7") {
    const t0 = new Date(t.getFullYear(), t.getMonth(), t.getDate());
    const t7 = new Date(t.getFullYear(), t.getMonth(), t.getDate() + 7);
    return list.filter(x => x._d >= t0 && x._d <= t7);
  }
  // Default: all due (including overdue)
  return list.filter(x => x._d <= t);
}

function weeklyReport(db, refDay) {
  const ref = parseDateSafe(refDay) || new Date();
  const { start, end, startStr, endStr } = weekRange(ref);
  
  const inRange = (ds) => {
    const d = parseDateSafe(ds);
    return d && d >= start && d <= end;
  };
  
  const timeByChannel = Object.fromEntries(CHANNELS.map(c => [c, 0]));
  let total = 0;
  
  db.actions.forEach(a => {
    if (inRange(a.when)) {
      const m = Number(a.minutes || 0);
      if (timeByChannel[a.channel] !== undefined) timeByChannel[a.channel] += m;
      total += m;
    }
  });
  
  const pipelineCounts = Object.fromEntries(PIPELINE.map(p => [p, 0]));
  db.conversations.forEach(c => {
    if (pipelineCounts[c.stage] !== undefined) pipelineCounts[c.stage] += 1;
  });
  
  return { startStr, endStr, timeByChannel, total, pipelineCounts };
}

function calculateStorageUsage(db) {
  const dataStr = JSON.stringify(db);
  const bytes = new Blob([dataStr]).size;
  const kb = bytes / 1024;
  const mb = kb / 1024;
  
  return {
    bytes,
    kb: kb.toFixed(2),
    mb: mb.toFixed(2),
    percent: ((bytes / (5 * 1024 * 1024)) * 100).toFixed(1) // 5MB is typical localStorage limit
  };
}

/* =========================
   RENDER FUNCTIONS
========================= */
function render() {
  try {
    const db = loadDB();
    const day = todayStr();
    
    // Update metadata
    el("metaActions").textContent = `Azioni: ${db.actions.length}`;
    el("metaConvs").textContent = `Conversazioni: ${db.conversations.length}`;
    el("metaToday").textContent = `Oggi: ${formatDate(day)}`;
    
    // Set default date
    if (!el("a_when").value) el("a_when").value = day;
    
    // Actions today
    const at = actionsToday(db, day);
    const totalMin = at.reduce((s, x) => s + Number(x.minutes || 0), 0);
    el("kpiMinutesToday").textContent = `${totalMin} min`;
    el("kpiMinutesTodaySub").textContent = at.length ? `${at.length} azioni registrate` : `Nessuna azione oggi`;
    
    el("actionsTodayBox").textContent = at.length
      ? `Totale oggi: ${totalMin} min\n` + at.slice().reverse().map(a => `- [${a.channel}] ${a.minutes}m ‚Äî ${a.note || ""}`).join("\n")
      : "Nessuna azione registrata oggi.";
    
    // Follow-up KPIs
    const overdue = followupsByType(db, day, "overdue");
    const dueToday = followupsByType(db, day, "today");
    el("kpiOverdue").textContent = `${overdue.length}`;
    el("kpiDueToday").textContent = `${dueToday.length}`;
    
    // Follow-ups box
    const fu = followupsByType(db, day, "");
    el("followupsBox").textContent = fu.length 
      ? `In scadenza (‚â§ oggi): ${fu.length}` 
      : "Nessun follow-up in scadenza üéâ";
    renderFollowupsList(el("followupsList"), fu, day);
    
    // Storage usage
    const storage = calculateStorageUsage(db);
    el("kpiStorage").textContent = `${storage.kb} KB`;
    el("kpiStorageSub").textContent = `${storage.percent}% utilizzato`;
    
    // Report
    const rep = weeklyReport(db, day);
    const t = rep.timeByChannel;
    const p = rep.pipelineCounts;
    el("reportBox").textContent =
      `Settimana: ${rep.startStr} ‚Üí ${rep.endStr}\n\n` +
      `Tempo per canale:\n` +
      Object.keys(t).map(k => `- ${k}: ${t[k]} min`).join("\n") +
      `\n\nPipeline:\n` +
      Object.keys(p).map(k => `- ${k}: ${p[k]}`).join("\n") +
      `\n\nTotale minuti: ${rep.total}`;
    
    // Last backup info
    if (db.meta.last_backup) {
      const lastBackup = new Date(db.meta.last_backup);
      el("lastBackupInfo").textContent = `Ultimo backup: ${formatDate(lastBackup)}`;
    }
    
    // Update connection status
    updateConnectionStatus();
    
  } catch (error) {
    console.error("Render error:", error);
    showToast("Errore aggiornamento interfaccia", "error");
  }
}

function renderFollowupsList(container, items, day) {
  container.innerHTML = "";
  
  if (!items.length) {
    const empty = document.createElement("div");
    empty.className = "item";
    empty.innerHTML = `<div class="subtle">Nessun elemento da visualizzare</div>`;
    container.appendChild(empty);
    return;
  }
  
  items.slice(0, 50).forEach(c => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${sanitizeInput(c.name)}</b>
      <span class="pill" style="margin-left:8px">${c.stage}</span>
      <span class="pill" style="margin-left:6px">${c.next_followup || "‚Äî"}</span>
      ${dueBadge(day, c.next_followup)}
      <div class="subtle">${sanitizeInput(c.city_zone || "")} ‚Äî ${sanitizeInput(c.origin || "")}</div>
      ${c.tags?.length ? `<div>${formatTags(c.tags)}</div>` : ""}
      ${c.note ? `<div class="subtle">${sanitizeInput(c.note).substring(0, 160)}${c.note.length > 160 ? "..." : ""}</div>` : ""}
      <div class="row" style="margin-top:8px">
        ${PIPELINE.map(s => `<button class="btn tiny gray" data-act="stage" data-id="${c.id}" data-stage="${s}">${s}</button>`).join("")}
        <button class="btn tiny gray" data-act="edit" data-id="${c.id}">‚úèÔ∏è Modifica</button>
        <button class="btn tiny gray" data-act="note" data-id="${c.id}">üìù Nota</button>
        <button class="btn tiny gray" data-act="follow" data-id="${c.id}">üìÖ Follow-up</button>
      </div>
    `;
    container.appendChild(div);
  });
  
  attachListEventHandlers(container);
}

function dueBadge(day, nextFollow) {
  const t = parseDateSafe(day);
  const d = parseDateSafe(nextFollow);
  if (!t || !d) return `<span class="pill">‚Äî</span>`;
  
  const t0 = new Date(t.getFullYear(), t.getMonth(), t.getDate());
  const d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diffDays = Math.round((d0 - t0) / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) return `<span class="pill bad">scaduto (${Math.abs(diffDays)}g)</span>`;
  if (diffDays === 0) return `<span class="pill warn">oggi</span>`;
  if (diffDays <= 3) return `<span class="pill warn">+${diffDays}g</span>`;
  return `<span class="pill">+${diffDays}g</span>`;
}

function formatTags(tags) {
  const arr = Array.isArray(tags) ? tags : normalizeTags(tags || "");
  if (!arr.length) return "";
  return arr.map(t => `<span class="tag">#${sanitizeInput(t)}</span>`).join("");
}

function attachListEventHandlers(container) {
  container.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      const db = loadDB();
      const conv = db.conversations.find(c => c.id === id);
      const day = todayStr();
      
      if (!conv) return;
      
      switch (act) {
        case "stage":
          conv.stage = btn.dataset.stage;
          if (conv.stage === "incarico" || conv.stage === "persa") {
            conv.next_followup = null;
          }
          conv.last_touch = day;
          saveDB(db);
          render();
          showToast(`Stato aggiornato a ${conv.stage}`, "success");
          break;
          
        case "note":
          const note = prompt("Nota da aggiungere:");
          if (note?.trim()) {
            conv.note = (conv.note ? conv.note + "\n" : "") + `[${day}] ${note.trim()}`;
            conv.last_touch = day;
            saveDB(db);
            render();
            showToast("Nota aggiunta", "success");
          }
          break;
          
        case "follow":
          const nd = prompt("Nuova data follow-up (YYYY-MM-DD) o vuoto per rimuovere:", conv.next_followup || "");
          if (nd !== null) {
            conv.next_followup = nd.trim() ? nd.trim() : null;
            conv.last_touch = day;
            saveDB(db);
            render();
            showToast("Follow-up aggiornato", "success");
          }
          break;
          
        case "edit":
          openEditConversation(id);
          break;
      }
    });
  });
}

function renderWeeklyChart() {
  const db = loadDB();
  const chartSection = el("chartSection");
  const chartContainer = el("weeklyChart");
  
  if (db.actions.length === 0) {
    chartSection.style.display = "none";
    return;
  }
  
  chartSection.style.display = "block";
  
  // Get last 7 days
  const today = new Date();
  const days = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    days.push(formatDate(d).split("/").reverse().join("-"));
  }
  
  // Calculate minutes per day
  const data = days.map(day => {
    const minutes = db.actions
      .filter(a => a.when === day)
      .reduce((sum, a) => sum + Number(a.minutes || 0), 0);
    return { day, minutes };
  });
  
  const maxMinutes = Math.max(...data.map(d => d.minutes), 1);
  
  chartContainer.innerHTML = data.map(d => `
    <div class="chart-label">
      <span>${formatDate(d.day)}</span>
      <span>${d.minutes} min</span>
    </div>
    <div class="chart-bar" style="width: ${(d.minutes / maxMinutes) * 100}%"></div>
  `).join("");
}

function renderStatsDialog() {
  const db = loadDB();
  const dialog = el("dlgStats");
  
  // Basic stats
  el("statTotalActions").textContent = db.actions.length;
  el("statTotalConvs").textContent = db.conversations.length;
  el("statTotalMinutes").textContent = db.actions.reduce((sum, a) => sum + Number(a.minutes || 0), 0);
  el("statActiveLeads").textContent = db.conversations.filter(c => !["incarico", "persa"].includes(c.stage)).length;
  
  // Channels chart (last 30 days)
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  const channelData = CHANNELS.map(channel => {
    const minutes = db.actions
      .filter(a => a.channel === channel && parseDateSafe(a.when) >= thirtyDaysAgo)
      .reduce((sum, a) => sum + Number(a.minutes || 0), 0);
    return { channel, minutes };
  }).filter(d => d.minutes > 0);
  
  const maxChannel = Math.max(...channelData.map(d => d.minutes), 1);
  
  el("statsChannelsChart").innerHTML = channelData.map(d => `
    <div class="chart-label">
      <span>${d.channel}</span>
      <span>${d.minutes} min</span>
    </div>
    <div class="chart-bar" style="width: ${(d.minutes / maxChannel) * 100}%"></div>
  `).join("");
  
  // Pipeline chart
  const pipelineData = PIPELINE.map(stage => {
    const count = db.conversations.filter(c => c.stage === stage).length;
    return { stage, count };
  });
  
  const maxPipeline = Math.max(...pipelineData.map(d => d.count), 1);
  
  el("statsPipelineChart").innerHTML = pipelineData.map(d => `
    <div class="chart-label">
      <span>${d.stage}</span>
      <span>${d.count}</span>
    </div>
    <div class="chart-bar" style="width: ${(d.count / maxPipeline) * 100}%"></div>
  `).join("");
  
  dialog.showModal();
}

/* =========================
   EDIT DIALOGS
========================= */
function openEditConversation(id) {
  const db = loadDB();
  const c = db.conversations.find(x => x.id === id);
  if (!c) {
    showToast("Conversazione non trovata", "error");
    return;
  }
  
  el("e_id").value = c.id;
  el("e_name").value = sanitizeInput(c.name || "");
  el("e_zone").value = sanitizeInput(c.city_zone || "");
  el("e_origin").value = sanitizeInput(c.origin || "");
  el("e_stage").value = c.stage || "aperta";
  el("e_follow").value = c.next_followup || "";
  el("e_tags").value = (Array.isArray(c.tags) ? c.tags : []).join(", ");
  el("e_phone").value = sanitizeInput(c.phone || "");
  el("e_email").value = sanitizeInput(c.email || "");
  el("e_link").value = sanitizeInput(c.link || "");
  el("e_last").value = c.last_touch || "";
  el("e_note").value = sanitizeInput(c.note || "");
  
  el("dlgConv").showModal();
}

function openEditAction(id) {
  const db = loadDB();
  const a = db.actions.find(x => x.id === id);
  if (!a) {
    showToast("Azione non trovata", "error");
    return;
  }
  
  el("ea_id").value = a.id;
  el("ea_when").value = a.when || todayStr();
  el("ea_channel").value = a.channel || CHANNELS[0];
  el("ea_minutes").value = a.minutes || 30;
  el("ea_note").value = sanitizeInput(a.note || "");
  
  el("dlgAction").showModal();
}

/* =========================
   EVENT HANDLERS
========================= */
function updateConnectionStatus() {
  const isOnline = navigator.onLine;
  const statusPill = el("statusPill");
  const connectionStatus = el("connectionStatus");
  
  if (isOnline) {
    statusPill.textContent = "Online ‚Ä¢ LocalStorage ‚Ä¢ Export CSV/JSON ‚Ä¢ PWA";
    connectionStatus.classList.remove("bad");
    connectionStatus.classList.add("info");
  } else {
    statusPill.textContent = "Offline ‚Ä¢ LocalStorage ‚Ä¢ Export CSV/JSON ‚Ä¢ PWA";
    connectionStatus.classList.remove("info");
    connectionStatus.classList.add("bad");
  }
}

function handleAddAction() {
  const db = loadDB();
  const when = el("a_when").value || todayStr();
  const channel = el("a_channel").value;
  const minutes = parseInt(el("a_minutes").value || "0", 10);
  const note = sanitizeInput(el("a_note").value || "").trim();
  
  const errors = validateAction({ when, channel, minutes, note });
  if (errors.length) {
    showToast(errors.join(", "), "error");
    return;
  }
  
  db.actions.push({
    id: `act_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    when,
    channel,
    minutes,
    note,
    created_at: new Date().toISOString()
  });
  
  if (saveDB(db)) {
    el("a_note").value = "";
    showToast("Azione salvata con successo", "success");
    render();
    renderWeeklyChart();
  }
}

function handleAddConversation() {
  const db = loadDB();
  const name = sanitizeInput(el("c_name").value || "Senza nome").trim();
  const city_zone = sanitizeInput(el("c_zone").value || "N/D").trim();
  const origin = sanitizeInput(el("c_origin").value || "N/D").trim();
  const stage = el("c_stage").value;
  const next_followup = el("c_follow").value ? el("c_follow").value : null;
  const tags = normalizeTags(el("c_tags").value || "");
  const phone = sanitizeInput(el("c_phone").value || "").trim();
  const email = sanitizeInput(el("c_email").value || "").trim();
  const link = sanitizeInput(el("c_link").value || "").trim();
  const noteShort = sanitizeInput(el("c_note_short").value || "").trim();
  const noteLong = sanitizeInput(el("c_note").value || "").trim();
  const created = todayStr();
  
  const errors = validateConversation({ name, city_zone, stage, next_followup, email, phone });
  if (errors.length) {
    showToast(errors.join(", "), "error");
    return;
  }
  
  const note = [noteShort, noteLong].filter(Boolean).join("\n");
  
  db.conversations.push({
    id: `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    name,
    city_zone,
    origin,
    stage,
    created,
    last_touch: created,
    next_followup,
    note,
    tags,
    phone,
    email,
    link
  });
  
  if (saveDB(db)) {
    // Clear form
    el("c_name").value = "";
    el("c_zone").value = "";
    el("c_origin").value = "";
    el("c_follow").value = "";
    el("c_tags").value = "";
    el("c_phone").value = "";
    el("c_email").value = "";
    el("c_link").value = "";
    el("c_note_short").value = "";
    el("c_note").value = "";
    
    showToast("Conversazione salvata con successo", "success");
    render();
  }
}

function handleSearch() {
  const query = (el("q").value || "").toLowerCase().trim();
  const db = loadDB();
  const resultsContainer = el("searchResults");
  const countElement = el("searchCount");
  
  if (!query) {
    resultsContainer.innerHTML = "";
    countElement.textContent = "0";
    return;
  }
  
  const results = db.conversations.filter(c => {
    const searchable = [
      c.id, c.name, c.city_zone, c.origin, c.stage, c.note,
      (Array.isArray(c.tags) ? c.tags.join(" ") : ""),
      c.phone, c.email, c.link, c.next_followup
    ].join(" ").toLowerCase();
    
    return searchable.includes(query);
  }).slice(0, 50);
  
  countElement.textContent = results.length;
  
  if (!results.length) {
    resultsContainer.innerHTML = `
      <div class="item">
        <div class="subtle">Nessun risultato per "${query}"</div>
      </div>
    `;
    return;
  }
  
  const day = todayStr();
  resultsContainer.innerHTML = results.map(c => `
    <div class="item">
      <b>${sanitizeInput(c.name)}</b>
      <span class="pill" style="margin-left:8px">${c.stage}</span>
      <div class="subtle">${sanitizeInput(c.city_zone)} ‚Äî ${sanitizeInput(c.origin)} ‚Äî follow-up: ${c.next_followup || "‚Äî"} ${dueBadge(day, c.next_followup)}</div>
      ${c.tags?.length ? `<div>${formatTags(c.tags)}</div>` : ""}
      ${c.note ? `<div class="subtle">${sanitizeInput(c.note).substring(0, 160)}${c.note.length > 160 ? "..." : ""}</div>` : ""}
      <div class="row" style="margin-top:8px">
        <button class="btn tiny gray" data-act="edit" data-id="${c.id}">‚úèÔ∏è Modifica</button>
        <button class="btn tiny gray" data-act="note" data-id="${c.id}">üìù Nota</button>
        <button class="btn tiny gray" data-act="follow" data-id="${c.id}">üìÖ Follow-up</button>
      </div>
    </div>
  `).join("");
  
  attachListEventHandlers(resultsContainer);
}

function handleFilters() {
  const db = loadDB();
  const stage = (el("f_stage").value || "").trim();
  const due = (el("f_due").value || "").trim();
  const tag = (el("f_tag").value || "").trim().toLowerCase();
  
  let results = db.conversations.slice();
  
  // Apply stage filter
  if (stage) {
    results = results.filter(c => c.stage === stage);
  }
  
  // Apply due filter
  if (due) {
    const day = todayStr();
    if (due === "none") {
      results = results.filter(c => !c.next_followup);
    } else {
      const filteredIds = followupsByType(db, day, due).map(x => x.id);
      const idSet = new Set(filteredIds);
      results = results.filter(c => idSet.has(c.id));
    }
  }
  
  // Apply tag filter
  if (tag) {
    results = results.filter(c => 
      Array.isArray(c.tags) && c.tags.some(t => String(t).toLowerCase().includes(tag))
    );
  }
  
  // Sort
  results.sort((a, b) => {
    const fa = a.next_followup || "9999-12-31";
    const fb = b.next_followup || "9999-12-31";
    const d = fa.localeCompare(fb);
    return d !== 0 ? d : (a.name || "").localeCompare(b.name || "");
  });
  
  const countElement = el("filterCount");
  countElement.textContent = results.length;
  
  renderFollowupsList(el("filterResults"), results, todayStr());
}

function handleExportCSV() {
  const db = loadDB();
  const day = todayStr();
  
  const actionsHeaders = ["id", "when", "channel", "minutes", "note", "created_at"];
  const convHeaders = ["id", "name", "city_zone", "origin", "stage", "created", "last_touch", "next_followup", "tags", "phone", "email", "link", "note"];
  
  const convRows = db.conversations.map(c => ({
    ...c,
    tags: Array.isArray(c.tags) ? c.tags.join(",") : ""
  }));
  
  downloadFile(`azioni_${day}.csv`, toCSV(db.actions, actionsHeaders), "text/csv;charset=utf-8");
  downloadFile(`conversazioni_${day}.csv`, toCSV(convRows, convHeaders), "text/csv;charset=utf-8");
  
  showToast("Esportazione CSV completata", "success");
}

function handleBackup() {
  const db = loadDB();
  const day = todayStr();
  downloadFile(`backup_dashboard_${day}.json`, JSON.stringify(db, null, 2), "application/json;charset=utf-8");
  showToast("Backup JSON creato", "success");
}

async function handleImport(event) {
  const file = event.target.files?.[0];
  if (!file) return;
  
  try {
    showLoading(true);
    const text = await file.text();
    const data = JSON.parse(text);
    
    if (!data || !Array.isArray(data.actions) || !Array.isArray(data.conversations)) {
      throw new Error("Formato JSON non valido");
    }
    
    // Validate and normalize data
    data.conversations = data.conversations.map(c => ({
      ...c,
      tags: Array.isArray(c.tags) ? c.tags : normalizeTags(c.tags || ""),
      phone: c.phone || "",
      email: c.email || "",
      link: c.link || "",
      note: c.note || ""
    }));
    
    data.version = 3;
    data.meta = data.meta || makeInitDB().meta;
    data.meta.imported_at = new Date().toISOString();
    
    if (confirm(`Importare ${data.actions.length} azioni e ${data.conversations.length} conversazioni? I dati attuali saranno sostituiti.`)) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      showToast("Import completato con successo", "success");
      render();
    }
  } catch (error) {
    console.error("Import error:", error);
    showToast(`Errore import: ${error.message}`, "error");
  } finally {
    showLoading(false);
    event.target.value = "";
  }
}

function handleReset() {
  if (confirm("ATTENZIONE: Reset totale dei dati su questo browser?\n\nQuesta operazione √® irreversibile. Assicurati di avere un backup.")) {
    localStorage.removeItem(STORAGE_KEY);
    showToast("Dati resettati", "warning");
    setTimeout(() => location.reload(), 1000);
  }
}

/* =========================
   PWA SETUP
========================= */
function setupPWA() {
  // Create manifest
  const manifest = {
    name: "Dashboard Lead Immobiliare",
    short_name: "Lead Dashboard",
    description: "Gestione lead immobiliari offline",
    start_url: ".",
    display: "standalone",
    background_color: "#0b1120",
    theme_color: "#0b1120",
    icons: [
      {
        src: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230b1120%22/><text y=%22.9em%22 font-size=%2290%22 fill=%22%23d8a23a%22>üè†</text></svg>",
        sizes: "512x512",
        type: "image/svg+xml"
      }
    ],
    categories: ["business", "productivity"],
    orientation: "portrait-primary"
  };
  
  const manifestBlob = new Blob([JSON.stringify(manifest)], {type: "application/json"});
  const manifestUrl = URL.createObjectURL(manifestBlob);
  
  const link = document.createElement("link");
  link.rel = "manifest";
  link.href = manifestUrl;
  document.head.appendChild(link);
  
  // Service Worker
  if ("serviceWorker" in navigator) {
    const swCode = `
      const CACHE = "dash-lead-v3";
      self.addEventListener("install", (e) => {
        e.waitUntil((async () => {
          const cache = await caches.open(CACHE);
          try {
            await cache.addAll(["./"]);
          } catch (e) {}
          self.skipWaiting();
        })());
      });
      self.addEventListener("activate", (e) => {
        e.waitUntil((async () => {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => k !== CACHE ? caches.delete(k) : null));
          self.clients.claim();
        })());
      });
      self.addEventListener("fetch", (e) => {
        e.respondWith((async () => {
          const cached = await caches.match(e.request);
          if (cached) return cached;
          try {
            const res = await fetch(e.request);
            if (res.status === 200) {
              const cache = await caches.open(CACHE);
              cache.put(e.request, res.clone());
            }
            return res;
          } catch (err) {
            return new Response("Offline", {
              status: 200,
              headers: {"Content-Type": "text/plain"}
            });
          }
        })());
      });
    `;
    
    const swBlob = new Blob([swCode], {type: "text/javascript"});
    const swUrl = URL.createObjectURL(swBlob);
    
    navigator.serviceWorker.register(swUrl)
      .then(reg => console.log("Service Worker registrato:", reg))
      .catch(err => console.log("Service Worker fallito:", err));
  }
}

/* =========================
   KEYBOARD SHORTCUTS
========================= */
function setupKeyboardShortcuts() {
  document.addEventListener("keydown", (e) => {
    // Ctrl+S for action form
    if ((e.ctrlKey || e.metaKey) && e.key === "s" && !e.shiftKey) {
      e.preventDefault();
      const actionBtn = el("btnAddAction");
      if (actionBtn && !actionBtn.disabled) {
        actionBtn.click();
      }
    }
    
    // Ctrl+Shift+S for conversation form
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "S") {
      e.preventDefault();
      const convBtn = el("btnAddConv");
      if (convBtn && !convBtn.disabled) {
        convBtn.click();
      }
    }
    
    // Escape to close dialogs
    if (e.key === "Escape") {
      const dialogs = document.querySelectorAll("dialog[open]");
      dialogs.forEach(dialog => dialog.close());
    }
    
    // Focus search on Ctrl+F
    if ((e.ctrlKey || e.metaKey) && e.key === "f") {
      e.preventDefault();
      const searchInput = el("q");
      if (searchInput) {
        searchInput.focus();
        searchInput.select();
      }
    }
  });
}

/* =========================
   INITIALIZATION
========================= */
document.addEventListener("DOMContentLoaded", () => {
  // Setup PWA
  setupPWA();
  
  // Fill selects
  const selects = {
    "a_channel": CHANNELS,
    "c_stage": PIPELINE,
    "e_stage": PIPELINE,
    "ea_channel": CHANNELS,
    "f_stage": PIPELINE
  };
  
  Object.entries(selects).forEach(([id, options]) => {
    const select = el(id);
    if (select && select.options.length <= 1) {
      options.forEach(opt => select.add(new Option(opt, opt)));
    }
  });
  
  // Set default date
  el("a_when").value = todayStr();
  
  // Setup event listeners
  el("btnScrollAction").addEventListener("click", () => el("secAction").scrollIntoView({behavior: "smooth"}));
  el("btnScrollConv").addEventListener("click", () => el("secConv").scrollIntoView({behavior: "smooth"}));
  
  el("btnAddAction").addEventListener("click", handleAddAction);
  el("btnAddConv").addEventListener("click", handleAddConversation);
  
  el("btnEditLastAction").addEventListener("click", () => {
    const db = loadDB();
    const last = db.actions[db.actions.length - 1];
    if (last) openEditAction(last.id);
    else showToast("Nessuna azione da modificare", "warning");
  });
  
  el("btnDeleteLastAction").addEventListener("click", () => {
    const db = loadDB();
    const last = db.actions[db.actions.length - 1];
    if (!last) {
      showToast("Nessuna azione da eliminare", "warning");
      return;
    }
    
    if (confirm("Eliminare l'ultima azione?")) {
      db.actions = db.actions.filter(a => a.id !== last.id);
      if (saveDB(db)) {
        showToast("Azione eliminata", "success");
        render();
      }
    }
  });
  
  // Search with debounce
  el("q").addEventListener("input", debounce(handleSearch, 300));
  el("btnSearch").addEventListener("click", handleSearch);
  el("btnClearSearch").addEventListener("click", () => {
    el("q").value = "";
    el("searchResults").innerHTML = "";
    el("searchCount").textContent = "0";
  });
  
  // Filters
  el("btnApplyFilters").addEventListener("click", handleFilters);
  el("btnResetFilters").addEventListener("click", () => {
    el("f_stage").value = "";
    el("f_due").value = "";
    el("f_tag").value = "";
    el("filterResults").innerHTML = "";
    el("filterCount").textContent = "0";
  });
  
  // Quick filters
  el("btnQuickFiltersOverdue").addEventListener("click", () => {
    el("f_due").value = "overdue";
    handleFilters();
  });
  el("btnQuickFiltersToday").addEventListener("click", () => {
    el("f_due").value = "today";
    handleFilters();
  });
  el("btnQuickFiltersNext7").addEventListener("click", () => {
    el("f_due").value = "next7";
    handleFilters();
  });
  el("btnQuickAll").addEventListener("click", () => {
    el("f_stage").value = "";
    el("f_due").value = "";
    el("f_tag").value = "";
    handleFilters();
  });
  
  // Export/Import
  el("btnExportCSV").addEventListener("click", handleExportCSV);
  el("btnBackup").addEventListener("click", handleBackup);
  el("fileImport").addEventListener("change", handleImport);
  el("btnReset").addEventListener("click", handleReset);
  
  // Chart toggle
  el("btnToggleChart").addEventListener("click", () => {
    const chartSection = el("chartSection");
    const btn = el("btnToggleChart");
    if (chartSection.style.display === "none") {
      renderWeeklyChart();
      btn.textContent = "üìä Nascondi grafico";
    } else {
      chartSection.style.display = "none";
      btn.textContent = "üìä Mostra grafico";
    }
  });
  
  // Stats dialog
  el("btnStats").addEventListener("click", renderStatsDialog);
  
  // Istruzioni
  el("btnHelp").addEventListener("click", () => el("dlgHelp").showModal());
  
  // Dialog save handlers
  el("btnSaveConv").addEventListener("click", () => {
    const id = el("e_id").value;
    const db = loadDB();
    const c = db.conversations.find(x => x.id === id);
    
    if (!c) return;
    
    c.name = sanitizeInput(el("e_name").value || "Senza nome").trim();
    c.city_zone = sanitizeInput(el("e_zone").value || "N/D").trim();
    c.origin = sanitizeInput(el("e_origin").value || "N/D").trim();
    c.stage = el("e_stage").value;
    c.next_followup = el("e_follow").value ? el("e_follow").value : null;
    c.tags = normalizeTags(el("e_tags").value || "");
    c.phone = sanitizeInput(el("e_phone").value || "").trim();
    c.email = sanitizeInput(el("e_email").value || "").trim();
    c.link = sanitizeInput(el("e_link").value || "").trim();
    c.note = sanitizeInput(el("e_note").value || "").trim();
    c.last_touch = todayStr();
    
    if (c.stage === "incarico" || c.stage === "persa") {
      c.next_followup = null;
    }
    
    if (saveDB(db)) {
      el("dlgConv").close();
      showToast("Conversazione aggiornata", "success");
      render();
    }
  });
  
  el("btnDeleteConv").addEventListener("click", () => {
    const id = el("e_id").value;
    if (confirm("Eliminare questa conversazione?")) {
      const db = loadDB();
      db.conversations = db.conversations.filter(x => x.id !== id);
      if (saveDB(db)) {
        el("dlgConv").close();
        showToast("Conversazione eliminata", "success");
        render();
      }
    }
  });
  
  el("btnSaveAction").addEventListener("click", () => {
    const id = el("ea_id").value;
    const db = loadDB();
    const a = db.actions.find(x => x.id === id);
    
    if (!a) return;
    
    const when = el("ea_when").value || todayStr();
    const channel = el("ea_channel").value;
    const minutes = parseInt(el("ea_minutes").value || "0", 10);
    const note = sanitizeInput(el("ea_note").value || "").trim();
    
    const errors = validateAction({ when, channel, minutes, note });
    if (errors.length) {
      showToast(errors.join(", "), "error");
      return;
    }
    
    a.when = when;
    a.channel = channel;
    a.minutes = minutes;
    a.note = note;
    
    if (saveDB(db)) {
      el("dlgAction").close();
      showToast("Azione aggiornata", "success");
      render();
    }
  });
  
  el("btnDeleteAction").addEventListener("click", () => {
    const id = el("ea_id").value;
    if (confirm("Eliminare questa azione?")) {
      const db = loadDB();
      db.actions = db.actions.filter(x => x.id !== id);
      if (saveDB(db)) {
        el("dlgAction").close();
        showToast("Azione eliminata", "success");
        render();
      }
    }
  });
  
  // Setup keyboard shortcuts
  setupKeyboardShortcuts();
  
  // Setup connection monitoring
  window.addEventListener("online", updateConnectionStatus);
  window.addEventListener("offline", updateConnectionStatus);
  
  // Auto-save reminder
  setInterval(() => {
    const db = loadDB();
    const now = new Date();
    const lastBackup = db.meta.last_backup ? new Date(db.meta.last_backup) : null;
    
    if (!lastBackup || (now - lastBackup) > 7 * 24 * 60 * 60 * 1000) {
      showToast("Consiglio: fai un backup dei dati", "info", 5000);
    }
  }, 24 * 60 * 60 * 1000); // Once per day
  
  // Initial render
  render();
  renderWeeklyChart();
  updateConnectionStatus();
  
  // Show welcome message
  setTimeout(() => {
    const db = loadDB();
    if (db.actions.length === 0 && db.conversations.length === 0) {
      showToast("Benvenuto! Inizia registrando azioni e conversazioni.", "info", 10000);
    }
  }, 1000);
});

// Global error handler
window.addEventListener("error", (event) => {
  console.error("Global error:", event.error);
  showToast(`Errore: ${event.message}`, "error");
});

window.addEventListener("unhandledrejection", (event) => {
  console.error("Unhandled rejection:", event.reason);
  showToast(`Errore: ${event.reason}`, "error");
});
</script>
</body>
</html>
