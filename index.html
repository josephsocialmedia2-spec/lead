<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Acquisizione ‚Äì Routine Giornaliera</title>
  <style>
    :root { --bg:#0b0b0b; --fg:#fff; --muted:rgba(255,255,255,.7); --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.14); --accent:#00e5ff; }
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--fg); min-height:100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
      display:flex; flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:5;
      background: linear-gradient(to bottom, rgba(11,11,11,.98), rgba(11,11,11,.85));
      border-bottom:1px solid var(--border);
      padding:12px 12px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    h1{ font-size:16px; margin:0; letter-spacing:.2px; }
    .pill{
      font-size:13px; padding:8px 10px; border-radius:999px;
      border:1px solid var(--border); background:rgba(255,255,255,.05);
    }
    .pill b{ color: var(--accent); }
    button{
      background: var(--fg); color:#000; border:0; border-radius:12px;
      padding:10px 12px; font-weight:800; cursor:pointer;
      touch-action: manipulation;
    }
    button.secondary{
      background: rgba(255,255,255,.10); color: var(--fg);
      border:1px solid rgba(255,255,255,.18);
    }
    button.danger{
      background: rgba(255,60,60,.16); color: var(--fg);
      border:1px solid rgba(255,60,60,.35);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    main{ padding: 14px 12px 90px; display:flex; flex-direction:column; gap:12px; }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 18px 45px rgba(0,0,0,.25);
    }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .title{ font-weight:900; font-size:15px; }
    .desc{ color: var(--muted); font-size:13px; margin-top:6px; line-height:1.35; }
    .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      font-size:12px; padding:6px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16); background:rgba(0,0,0,.18);
      color: rgba(255,255,255,.85);
    }
    .progress{
      height:10px; width:100%;
      background: rgba(255,255,255,.08);
      border-radius:999px; overflow:hidden;
      margin-top:10px;
    }
    .bar{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(0,229,255,.85), rgba(0,229,255,.35));
    }
    .done{
      border-color: rgba(0,229,255,.35);
      background: rgba(0,229,255,.06);
    }
    details summary{ cursor:pointer; font-weight:800; }
    textarea, input[type="text"], input[type="number"], select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--fg);
      padding:10px 10px;
      font-size:14px;
      outline:none;
    }
    label{ font-size:12px; color: var(--muted); display:block; margin:10px 0 6px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width: 860px){
      .grid{ grid-template-columns: 1.1fr .9fr; }
    }
    .sticky-footer{
      position:fixed; left:0; right:0; bottom:0; z-index:6;
      background: rgba(11,11,11,.94);
      border-top:1px solid var(--border);
      padding:10px 12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      font-size:13px; color: var(--muted);
    }
    .kpi b{ color: var(--fg); }
    .small{ font-size:12px; color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .copyRow{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  </style>
</head>
<body>

<header>
  <h1>üìç Routine Acquisizione (Valle di Susa)</h1>
  <span class="pill">Oggi: <b id="todayLabel"></b></span>
  <span class="pill">Completamento: <b id="pctLabel">0%</b></span>
  <button id="notifyBtn" class="secondary">üîî Notifiche</button>
  <button id="resetDayBtn" class="danger">‚Ü∫ Reset oggi</button>
</header>

<main class="grid">
  <section class="card">
    <div class="row">
      <div>
        <div class="title">‚úÖ Checklist ‚ÄúMassacro‚Äù (60‚Äì90 min)</div>
        <div class="desc">Fai questi step in ordine. Spunta ‚ÄúFatto‚Äù, avvia i timer, copia gli script. Tutto si salva da solo.</div>
      </div>
      <div class="kpi">
        <span>Portali: <b id="kpiPortali">0</b></span>
        <span>DM: <b id="kpiDM">0</b></span>
        <span>Call: <b id="kpiCall">0</b></span>
      </div>
    </div>

    <div class="progress"><div class="bar" id="progressBar"></div></div>

    <div id="steps"></div>
  </section>

  <aside class="card">
    <div class="title">‚öôÔ∏è Impostazioni veloci</div>
    <div class="desc">Personalizza micro-zona, obiettivi giornalieri e orari promemoria.</div>

    <label>Micro-zona (scrivila come la dici tu)</label>
    <input id="zoneInput" type="text" placeholder="Es: Avigliana + Sant‚ÄôAmbrogio" />

    <label>Obiettivi di oggi</label>
    <div class="row">
      <div style="flex:1; min-width:160px;">
        <label class="small">Contatti portali</label>
        <input id="goalPortali" type="number" min="0" step="1" />
      </div>
      <div style="flex:1; min-width:160px;">
        <label class="small">DM attivi</label>
        <input id="goalDM" type="number" min="0" step="1" />
      </div>
      <div style="flex:1; min-width:160px;">
        <label class="small">Call</label>
        <input id="goalCall" type="number" min="0" step="1" />
      </div>
    </div>

    <label>Promemoria (solo se abiliti le notifiche)</label>
    <div class="row">
      <div style="flex:1; min-width:180px;">
        <label class="small">Orario 1 (HH:MM)</label>
        <input id="rem1" type="text" placeholder="09:30" />
      </div>
      <div style="flex:1; min-width:180px;">
        <label class="small">Orario 2 (HH:MM)</label>
        <input id="rem2" type="text" placeholder="18:30" />
      </div>
    </div>

    <div class="copyRow">
      <button id="saveSettingsBtn">üíæ Salva</button>
      <button id="fullscreenBtn" class="secondary">‚õ∂ Full screen</button>
    </div>

    <details style="margin-top:12px;">
      <summary>üìå Note</summary>
      <div class="desc" style="margin-top:8px;">
        ‚Ä¢ Le notifiche funzionano meglio se la pagina resta aperta (o se la aggiungi alla Home).<br>
        ‚Ä¢ Se vuoi promemoria ‚Äúsempre‚Äù, ti conviene metterli anche nella sveglia/calendario del telefono.
      </div>
    </details>

    <label style="margin-top:12px;">Note di oggi</label>
    <textarea id="dailyNotes" placeholder="Scrivi qui: risposte, obiezioni, follow-up‚Ä¶"></textarea>
  </aside>
</main>

<div class="sticky-footer">
  <div class="kpi">
    <span class="pill">Zona: <b id="zoneLabel">‚Äî</b></span>
    <span class="pill">Timer: <b id="timerLabel">00:00</b></span>
  </div>
  <div class="copyRow">
    <button id="startTimerBtn">‚è±Ô∏è Avvia timer</button>
    <button id="pauseTimerBtn" class="secondary">‚è∏Ô∏è Pausa</button>
    <button id="stopTimerBtn" class="secondary">‚èπÔ∏è Stop</button>
  </div>
</div>

<script>
(() => {
  const TZ = "Europe/Rome";
  const STORAGE_KEY = "acq_routine_v1";
  const todayLabel = document.getElementById("todayLabel");
  const pctLabel = document.getElementById("pctLabel");
  const progressBar = document.getElementById("progressBar");
  const stepsEl = document.getElementById("steps");

  const zoneInput = document.getElementById("zoneInput");
  const zoneLabel = document.getElementById("zoneLabel");
  const goalPortali = document.getElementById("goalPortali");
  const goalDM = document.getElementById("goalDM");
  const goalCall = document.getElementById("goalCall");
  const rem1 = document.getElementById("rem1");
  const rem2 = document.getElementById("rem2");
  const dailyNotes = document.getElementById("dailyNotes");

  const kpiPortali = document.getElementById("kpiPortali");
  const kpiDM = document.getElementById("kpiDM");
  const kpiCall = document.getElementById("kpiCall");

  const notifyBtn = document.getElementById("notifyBtn");
  const resetDayBtn = document.getElementById("resetDayBtn");
  const saveSettingsBtn = document.getElementById("saveSettingsBtn");
  const fullscreenBtn = document.getElementById("fullscreenBtn");

  const timerLabel = document.getElementById("timerLabel");
  const startTimerBtn = document.getElementById("startTimerBtn");
  const pauseTimerBtn = document.getElementById("pauseTimerBtn");
  const stopTimerBtn = document.getElementById("stopTimerBtn");

  // ---- Date helpers (local day key in Europe/Rome)
  function getRomeDayKey(d = new Date()){
    const fmt = new Intl.DateTimeFormat("it-IT", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" });
    const parts = fmt.formatToParts(d);
    const y = parts.find(p=>p.type==="year").value;
    const m = parts.find(p=>p.type==="month").value;
    const da = parts.find(p=>p.type==="day").value;
    return `${y}-${m}-${da}`;
  }
  function prettyToday(){
    const fmt = new Intl.DateTimeFormat("it-IT", { timeZone: TZ, weekday:"long", day:"2-digit", month:"long", year:"numeric" });
    return fmt.format(new Date());
  }
  todayLabel.textContent = prettyToday();

  // ---- Default steps
  const DEFAULT_STEPS = [
    {
      id:"portali",
      title:"1) Portali (20 min) ‚Äì 5 contatti",
      minutes:20,
      why:"Obiettivo: parlare con proprietari (annunci > 90 giorni).",
      doList:[
        "Apri Immobiliare.it / Idealista",
        "Filtra: zona (micro-zona) + annunci > 90 giorni",
        "Contatta 5 proprietari (meglio privati)",
      ],
      scripts:[
        {
          label:"Messaggio Portali (copy)",
          text:"Ciao, ho visto l‚Äôannuncio della casa a [COMUNE]. Se √® online da un po‚Äô, spesso il blocco non √® ‚Äòsfortuna‚Äô ma 1‚Äì2 cose precise. Se vuoi, in 10 minuti ti dico cosa controllare nel tuo caso."
        }
      ],
      kpi:{ portali:+5 }
    },
    {
      id:"reel",
      title:"2) Reel (15 min) ‚Äì 1 video",
      minutes:15,
      why:"√à l‚Äôesca: chi si riconosce ti scrive.",
      doList:[
        "Hook 3s: ‚ÄòSe la tua casa in Valle di Susa √® online da mesi‚Ä¶‚Äô",
        "1 idea: ‚Äòspesso non √® il prezzo, ma‚Ä¶‚Äô",
        "CTA: ‚ÄòScrivimi INVENDUTA‚Äô",
        "Pubblica su IG + TikTok"
      ],
      scripts:[
        {
          label:"Script Reel pronto",
          text:"Se hai una casa in Valle di Susa online da mesi e non si vende, ascolta: spesso il problema non √® il prezzo, ma come viene percepita da foto e annuncio. Scrivimi ‚ÄòINVENDUTA‚Äô e ti dico cosa controllare nel tuo caso."
        }
      ],
      kpi:{}
    },
    {
      id:"stories",
      title:"3) Stories (5 min) ‚Äì 3 stories",
      minutes:5,
      why:"Le stories sono il ‚Äòvolantino moderno‚Äô e aprono DM.",
      doList:[
        "Story 1: sondaggio ‚ÄòStai pensando di vendere entro 6 mesi?‚Äô",
        "Story 2: box ‚ÄòComune + mq: ti dico il range‚Äô",
        "Story 3: CTA ‚ÄòDM VALLE per check 10 min‚Äô"
      ],
      scripts:[
        {
          label:"Testo Story CTA",
          text:"Se sei proprietario in [ZONA], scrivimi ‚ÄòVALLE‚Äô in DM: ti dico cosa sta succedendo sul mercato e cosa controllare prima di vendere."
        }
      ],
      kpi:{}
    },
    {
      id:"dm",
      title:"4) DM (25 min) ‚Äì 5 DM attivi",
      minutes:25,
      why:"Qui si fa la conversione: domande ‚Üí call.",
      doList:[
        "Scrivi a 5 persone: visualizzazioni stories / interazioni",
        "Non vendere: qualifica con 4 domande",
        "Chiudi sempre chiedendo la call"
      ],
      scripts:[
        {
          label:"DM soft (apertura)",
          text:"Ciao! Vedo che segui i contenuti sulla Valle di Susa. Sei in fase curiosit√† o stai valutando di vendere nei prossimi mesi?"
        },
        {
          label:"4 domande (una alla volta)",
          text:"1) In che comune/frazione √®?\n2) Prima casa, seconda casa o eredit√†?\n3) Da quanto √® in vendita / perch√© vendi?\n4) Entro quando vuoi risolvere?"
        },
        {
          label:"Chiusura ‚Üí call",
          text:"Perfetto. Se vuoi, in 10 minuti ti dico cosa farei io nel tuo caso. Meglio una call oggi o domani?"
        }
      ],
      kpi:{ dm:+5 }
    },
    {
      id:"call",
      title:"5) Call (10 min) ‚Äì 1 call breve",
      minutes:10,
      why:"La call serve a fissare sopralluogo, non a ‚Äòconvincere‚Äô.",
      doList:[
        "2 min: obiettivo + tempistiche",
        "3 min: blocco principale",
        "3 min: 2 azioni pratiche",
        "2 min: proposta sopralluogo"
      ],
      scripts:[
        {
          label:"Chiusura sopralluogo",
          text:"Ti va che passo 20 minuti a vedere casa e ti porto un piano di vendita? Cos√¨ capisci subito se ha senso."
        }
      ],
      kpi:{ call:+1 }
    }
  ];

  // ---- State
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    const dayKey = getRomeDayKey();
    const defaults = {
      dayKey,
      settings: {
        zone: "Valle di Susa",
        goals: { portali:5, dm:5, call:1 },
        reminders: { rem1:"09:30", rem2:"18:30" }
      },
      steps: DEFAULT_STEPS.map(s => ({ id:s.id, done:false })),
      kpi: { portali:0, dm:0, call:0 },
      notes: "",
      timer: { seconds:0, running:false, startedAt:null }
    };

    if (!raw) return defaults;
    try {
      const st = JSON.parse(raw);
      // new day -> reset day-specific fields
      if (st.dayKey !== dayKey) {
        st.dayKey = dayKey;
        st.steps = DEFAULT_STEPS.map(s => ({ id:s.id, done:false }));
        st.kpi = { portali:0, dm:0, call:0 };
        st.notes = "";
        st.timer = { seconds:0, running:false, startedAt:null };
      }
      return { ...defaults, ...st, settings: { ...defaults.settings, ...(st.settings||{}) } };
    } catch {
      return defaults;
    }
  }

  let state = loadState();
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  // ---- UI render
  function computePct(){
    const total = DEFAULT_STEPS.length;
    const done = state.steps.filter(s=>s.done).length;
    return total ? Math.round((done/total)*100) : 0;
  }

  function updateKPI(){
    kpiPortali.textContent = state.kpi.portali;
    kpiDM.textContent = state.kpi.dm;
    kpiCall.textContent = state.kpi.call;
  }

  function renderHeader(){
    const pct = computePct();
    pctLabel.textContent = pct + "%";
    progressBar.style.width = pct + "%";
    zoneLabel.textContent = state.settings.zone || "‚Äî";

    zoneInput.value = state.settings.zone || "";
    goalPortali.value = state.settings.goals?.portali ?? 5;
    goalDM.value = state.settings.goals?.dm ?? 5;
    goalCall.value = state.settings.goals?.call ?? 1;
    rem1.value = state.settings.reminders?.rem1 ?? "09:30";
    rem2.value = state.settings.reminders?.rem2 ?? "18:30";
    dailyNotes.value = state.notes || "";

    updateKPI();
  }

  function copyToClipboard(text){
    navigator.clipboard?.writeText(text).catch(()=>{});
  }

  function renderSteps(){
    stepsEl.innerHTML = "";
    DEFAULT_STEPS.forEach(step => {
      const sState = state.steps.find(s=>s.id===step.id) || { done:false };
      const card = document.createElement("div");
      card.className = "card" + (sState.done ? " done" : "");
      card.style.marginTop = "12px";

      const top = document.createElement("div");
      top.className = "row";
      top.innerHTML = `
        <div>
          <div class="title">${step.title}</div>
          <div class="desc">${step.why}</div>
        </div>
        <div class="copyRow">
          <button class="secondary" data-action="timer" data-min="${step.minutes}">‚è±Ô∏è ${step.minutes}m</button>
          <button data-action="toggle">${sState.done ? "‚úÖ Fatto" : "‚¨ú Fatto"}</button>
        </div>
      `;
      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span class="chip">Durata: ${step.minutes} min</span>
        ${step.kpi?.portali ? `<span class="chip">+${step.kpi.portali} portali</span>` : ""}
        ${step.kpi?.dm ? `<span class="chip">+${step.kpi.dm} DM</span>` : ""}
        ${step.kpi?.call ? `<span class="chip">+${step.kpi.call} call</span>` : ""}
      `;
      card.appendChild(meta);

      const list = document.createElement("div");
      list.className = "desc";
      list.style.marginTop = "10px";
      list.innerHTML = "<b>Cosa fai:</b><br>" + step.doList.map(x=>"‚Ä¢ "+x).join("<br>");
      card.appendChild(list);

      const details = document.createElement("details");
      details.style.marginTop = "10px";
      const sum = document.createElement("summary");
      sum.textContent = "üìã Script pronti (copia)";
      details.appendChild(sum);

      const scriptsWrap = document.createElement("div");
      scriptsWrap.style.marginTop = "10px";
      step.scripts.forEach(sc => {
        const block = document.createElement("div");
        block.className = "card";
        block.style.padding = "10px";
        block.style.marginTop = "10px";
        block.innerHTML = `
          <div class="row">
            <div class="title" style="font-size:13px;">${sc.label}</div>
            <button class="secondary" data-action="copy">üìé Copia</button>
          </div>
          <div class="desc mono" style="white-space:pre-wrap; margin-top:8px;">${escapeHtml(sc.text)}</div>
        `;
        block.querySelector('[data-action="copy"]').addEventListener("click", () => copyToClipboard(sc.text));
        scriptsWrap.appendChild(block);
      });
      details.appendChild(scriptsWrap);
      card.appendChild(details);

      // actions
      top.querySelector('[data-action="toggle"]').addEventListener("click", () => toggleDone(step.id));
      top.querySelector('[data-action="timer"]').addEventListener("click", (e) => {
        const m = parseInt(e.currentTarget.getAttribute("data-min"), 10);
        startStepTimer(m);
      });

      stepsEl.appendChild(card);
    });
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    })[s]);
  }

  function toggleDone(id){
    const s = state.steps.find(x=>x.id===id);
    if (!s) return;
    const stepDef = DEFAULT_STEPS.find(x=>x.id===id);
    const wasDone = s.done;
    s.done = !s.done;

    // KPI adjustments only when marking done (not when unchecking)
    if (!wasDone && s.done && stepDef?.kpi){
      state.kpi.portali += stepDef.kpi.portali || 0;
      state.kpi.dm      += stepDef.kpi.dm || 0;
      state.kpi.call    += stepDef.kpi.call || 0;
    }

    saveState();
    renderHeader();
    renderSteps();
  }

  // ---- Settings
  function saveSettings(){
    state.settings.zone = zoneInput.value.trim() || "Valle di Susa";
    state.settings.goals = {
      portali: parseInt(goalPortali.value || "0",10),
      dm: parseInt(goalDM.value || "0",10),
      call: parseInt(goalCall.value || "0",10),
    };
    state.settings.reminders = {
      rem1: rem1.value.trim(),
      rem2: rem2.value.trim(),
    };
    saveState();
    renderHeader();
    scheduleLocalReminders(); // reschedule
  }

  saveSettingsBtn.addEventListener("click", saveSettings);

  dailyNotes.addEventListener("input", () => {
    state.notes = dailyNotes.value;
    saveState();
  });

  resetDayBtn.addEventListener("click", () => {
    const dayKey = getRomeDayKey();
    state.dayKey = dayKey;
    state.steps = DEFAULT_STEPS.map(s => ({ id:s.id, done:false }));
    state.kpi = { portali:0, dm:0, call:0 };
    state.notes = "";
    state.timer = { seconds:0, running:false, startedAt:null };
    saveState();
    renderHeader();
    renderSteps();
    updateTimerUI();
  });

  fullscreenBtn.addEventListener("click", async () => {
    try{
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    } catch(e){ console.warn(e); }
  });

  // ---- Global timer
  let interval = null;

  function updateTimerUI(){
    const sec = state.timer.seconds;
    const mm = String(Math.floor(sec/60)).padStart(2,"0");
    const ss = String(sec%60).padStart(2,"0");
    timerLabel.textContent = `${mm}:${ss}`;
  }

  function tick(){
    if (!state.timer.running) return;
    state.timer.seconds += 1;
    saveState();
    updateTimerUI();
  }

  function startGlobalTimer(){
    if (state.timer.running) return;
    state.timer.running = true;
    saveState();
    if (!interval) interval = setInterval(tick, 1000);
  }
  function pauseGlobalTimer(){
    state.timer.running = false;
    saveState();
  }
  function stopGlobalTimer(){
    state.timer.running = false;
    state.timer.seconds = 0;
    saveState();
    updateTimerUI();
  }

  startTimerBtn.addEventListener("click", startGlobalTimer);
  pauseTimerBtn.addEventListener("click", pauseGlobalTimer);
  stopTimerBtn.addEventListener("click", stopGlobalTimer);

  function startStepTimer(minutes){
    stopGlobalTimer();
    state.timer.running = true;
    state.timer.seconds = 0;
    saveState();
    updateTimerUI();
    if (!interval) interval = setInterval(tick, 1000);

    // Local countdown alert
    const target = minutes * 60;
    const check = setInterval(() => {
      if (!state.timer.running) return;
      if (state.timer.seconds >= target){
        clearInterval(check);
        state.timer.running = false;
        saveState();
        notify(`Timer finito: ${minutes} minuti`, "Passa allo step successivo üëä");
      }
    }, 500);
  }

  // ---- Notifications
  function canNotify(){ return "Notification" in window; }

  async function requestNotify(){
    if (!canNotify()) { alert("Notifiche non supportate in questo browser."); return; }
    const perm = await Notification.requestPermission();
    if (perm === "granted") {
      notifyBtn.textContent = "üîî Notifiche ON";
      scheduleLocalReminders();
      notify("Notifiche attive", "Ti ricorder√≤ la routine agli orari impostati.");
    } else {
      notifyBtn.textContent = "üîî Notifiche";
    }
  }

  function notify(title, body){
    if (canNotify() && Notification.permission === "granted") {
      try { new Notification(title, { body }); } catch {}
    }
  }

  notifyBtn.addEventListener("click", requestNotify);

  // Local reminders while page is open (simple scheduler)
  let reminderTimers = [];
  function clearReminders(){
    reminderTimers.forEach(t => clearTimeout(t));
    reminderTimers = [];
  }

  function parseHHMM(s){
    const m = /^(\d{1,2}):(\d{2})$/.exec((s||"").trim());
    if (!m) return null;
    const hh = Math.max(0, Math.min(23, parseInt(m[1],10)));
    const mm = Math.max(0, Math.min(59, parseInt(m[2],10)));
    return { hh, mm };
  }

  function scheduleOne(hhmm, label){
    const t = parseHHMM(hhmm);
    if (!t) return;
    // Compute next occurrence in Europe/Rome using local Date (good enough for daily reminders)
    const now = new Date();
    const target = new Date();
    target.setHours(t.hh, t.mm, 0, 0);
    if (target <= now) target.setDate(target.getDate() + 1);
    const ms = target.getTime() - now.getTime();
    const id = setTimeout(() => {
      notify("Routine acquisizione", label);
      // reschedule for next day
      scheduleLocalReminders();
    }, ms);
    reminderTimers.push(id);
  }

  function scheduleLocalReminders(){
    clearReminders();
    if (!(canNotify() && Notification.permission === "granted")) return;

    const z = state.settings.zone || "Valle di Susa";
    const msg1 = `Portali + Reel + Stories (${z}) ‚Äì inizia adesso`;
    const msg2 = `DM + Call: chiudi conversazioni e fissa sopralluoghi`;
    scheduleOne(state.settings.reminders?.rem1, msg1);
    scheduleOne(state.settings.reminders?.rem2, msg2);
  }

  // ---- Init
  function init(){
    renderHeader();
    renderSteps();
    updateTimerUI();

    // notify button label
    if (canNotify() && Notification.permission === "granted") notifyBtn.textContent = "üîî Notifiche ON";

    // keep reminders up to date
    scheduleLocalReminders();
  }
  init();
})();
</script>
</body>
</html>
