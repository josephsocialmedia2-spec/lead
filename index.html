 
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda a Blocchi Vincolanti ‚Äì Metodo Fa Cassa (OGGI)</title>
  <style>
    :root{ 
      --b:#d1d5db; 
      --bg:#f8fafc; 
      --ok:#dcfce7; 
      --ok-border:#86efac;
      --ok-text:#166534;
      --warn:#fef3c7; 
      --warn-border:#fcd34d;
      --warn-text:#92400e;
      --bad:#fee2e2; 
      --bad-border:#fca5a5;
      --bad-text:#991b1b;
      --card-bg:#ffffff;
      --text:#1f2937;
      --text-muted:#6b7280;
      --primary:#3b82f6;
      --primary-dark:#2563eb;
    }
    
    body{ 
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; 
      margin:20px; 
      color:var(--text); 
      background:#f1f5f9;
      line-height:1.5;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1{ 
      font-size:28px; 
      margin:0 0 8px 0;
      color:var(--text);
      font-weight:700;
    }
    
    h2{ 
      font-size:20px; 
      margin:0 0 16px 0;
      color:var(--text);
      font-weight:600;
    }
    
    .muted{ 
      color:var(--text-muted); 
      font-size:14px;
      margin-bottom:20px;
    }
    
    .grid{ 
      display:grid; 
      grid-template-columns:1fr; 
      gap:20px; 
      margin-bottom:20px;
    }
    
    @media(min-width:1100px){ 
      .grid{ 
        grid-template-columns:1.25fr .75fr; 
      }
    }
    
    .card{
      border:1px solid var(--b); 
      border-radius:16px; 
      padding:20px; 
      background:var(--card-bg);
      box-shadow:0 1px 3px rgba(0,0,0,0.05);
    }
    
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 14px; 
      border-radius:999px; 
      border:1px solid; 
      font-size:13px; 
      font-weight:500;
    }
    
    .pill.ok{ 
      background:var(--ok); 
      border-color:var(--ok-border);
      color:var(--ok-text);
    }
    
    .pill.warn{ 
      background:var(--warn); 
      border-color:var(--warn-border);
      color:var(--warn-text);
    }
    
    .pill.bad{ 
      background:var(--bad); 
      border-color:var(--bad-border);
      color:var(--bad-text);
    }
    
    .pill.info {
      background:#dbeafe;
      border-color:#93c5fd;
      color:#1e40af;
    }
    
    label{
      font-weight:600; 
      font-size:14px; 
      display:block; 
      margin:12px 0 6px;
      color:var(--text);
    }
    
    input, textarea, select, button{
      font:inherit;
      font-size:14px;
    }
    
    input, textarea, select{
      width:100%; 
      padding:10px 14px; 
      border:1px solid var(--b); 
      border-radius:10px; 
      background:#fff;
      transition:border-color 0.2s, box-shadow 0.2s;
    }
    
    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    textarea{
      min-height:80px; 
      resize:vertical;
    }
    
    button{
      padding:10px 16px; 
      border-radius:10px; 
      border:1px solid var(--b); 
      background:#fff;
      cursor:pointer;
      font-weight:500;
      transition:all 0.2s;
    }
    
    button:hover{
      background:var(--bg);
      transform:translateY(-1px);
    }
    
    button.primary{
      background:var(--primary); 
      color:#fff; 
      border-color:var(--primary);
    }
    
    button.primary:hover{
      background:var(--primary-dark);
    }
    
    .row{
      display:flex; 
      gap:16px; 
      flex-wrap:wrap; 
      align-items:flex-start;
      margin-bottom:8px;
    }
    
    .row > *{
      flex:1; 
      min-width:200px;
    }
    
    .row-center {
      align-items:center;
    }
    
    table{
      width:100%; 
      border-collapse:collapse;
      border-radius:12px;
      overflow:hidden;
    }
    
    th, td{
      border:1px solid var(--b); 
      padding:12px; 
      vertical-align:top;
    }
    
    th{
      background:var(--bg); 
      text-align:left; 
      font-size:13px;
      font-weight:600;
      color:var(--text-muted);
    }
    
    tbody tr:hover {
      background:#f9fafb;
    }
    
    .sticky{
      position:sticky; 
      top:20px;
    }
    
    .small{ 
      font-size:13px; 
    }
    
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono"; 
      font-size:13px; 
      white-space:pre-wrap;
    }
    
    .disabled{
      opacity:0.6;
      pointer-events:none;
    }
    
    .blockTitle{
      font-weight:700; 
      font-size:15px;
      margin-bottom:4px;
    }
    
    .time-cell {
      font-weight:500;
      color:var(--text);
    }
    
    .status-badge {
      display:inline-block;
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
      font-weight:500;
      margin-bottom:8px;
    }
    
    .status-todo {
      background:#fee2e2;
      color:#991b1b;
    }
    
    .status-done {
      background:#dcfce7;
      color:#166534;
    }
    
    .status-skip {
      background:#fef3c7;
      color:#92400e;
    }
    
    /* Progress indicator */
    .progress {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    
    .progress-bar {
      flex:1;
      height:6px;
      background:#e5e7eb;
      border-radius:3px;
      overflow:hidden;
    }
    
    .progress-fill {
      height:100%;
      background:linear-gradient(90deg, #3b82f6, #10b981);
      border-radius:3px;
      transition:width 0.3s ease;
    }
    
    /* Toast */
    .toast {
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--primary);
      color:white;
      padding:12px 20px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      transform:translateY(100px);
      opacity:0;
      transition:all 0.3s ease;
      z-index:1000;
    }
    
    .toast.show {
      transform:translateY(0);
      opacity:1;
    }
  </style>
</head>
<body>
<div class="container">

<h1>Agenda a Blocchi Vincolanti (08:30 ‚Üí 20:00) ‚Äì OGGI</h1>
<p class="muted">
  <strong>Regola:</strong> si sblocca un blocco solo quando chiudi quello precedente. Se salti, devi scrivere un motivo.
  Salvataggio automatico in locale. Export automatico alle 21:00 (download JSON).
</p>

<div class="grid">

  <div class="card">
    <h2>Setup (obbligatorio)</h2>
    <div class="row">
      <div>
        <span class="pill ok" id="pillToday"></span>
        <div class="muted small">Lavori SOLO su oggi. Niente domani, niente ieri.</div>
      </div>
      <div>
        <label>üìç Micro-zona di oggi</label>
        <input id="zona" placeholder="Es: Via X | Via Y | Condominio Z" />
      </div>
      <div>
        <label>üéØ Obiettivo del giorno (pipeline)</label>
        <input id="goal" placeholder="Es: 10 contatti classificati + 1 appuntamento fissato" />
      </div>
    </div>
    
    <!-- Progress -->
    <div class="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      <span class="small" id="progressText">0% completato</span>
    </div>
  </div>

  <div class="card sticky">
    <h2>Stato</h2>
    <div class="row-center">
      <div><span class="pill" id="pillProgress">0/9 blocchi</span></div>
      <div><span class="pill ok" id="pillExport">Export 21:00 attivo</span></div>
    </div>
    
    <!-- Current Status -->
    <div style="margin:16px 0;">
      <div class="small muted" style="margin-bottom:4px;">Blocco attivo:</div>
      <div class="small" id="currentBlock" style="font-weight:500;">Completa il setup per iniziare</div>
    </div>
    
    <div class="card" style="margin-top:10px; padding:16px; background:var(--bg);">
      <div class="muted small" style="margin-bottom:8px;">Sei vincolato: fai quello che c'√® scritto, nell'ordine.</div>
      <ul class="small" style="margin:0; padding-left:20px;">
        <li>üìç 1 micro-zona oggi</li>
        <li>üìù contatti scritti + classificati</li>
        <li>üìû follow-up in giornata</li>
      </ul>
      
      <div class="row" style="margin-top:16px;">
        <button class="primary" id="btnExportNow">
          üì• Export adesso
        </button>
        <button id="btnReset">
          üîÑ Reset oggi
        </button>
      </div>
      <p class="muted small" id="status" style="margin-top:12px; text-align:center;"></p>
    </div>
  </div>

  <div class="card" style="grid-column:1 / -1;">
    <h2>Agenda a Blocchi (vincolanti)</h2>
    <div style="overflow:auto;">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:140px">Orario</th>
            <th>Blocco (cosa fai)</th>
            <th style="width:220px">Output obbligatorio</th>
            <th style="width:180px">Stato</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:20px;">
      <div>
        <label>üìù Osservazioni zona (2 righe)</label>
        <textarea id="obs" placeholder="Cartelli, immobili fermi, segnali, negozi sentinella..."></textarea>
      </div>
      <div>
        <label>üéì Lezione del giorno (1 cosa imparata)</label>
        <textarea id="lesson" placeholder="Es: sopra X resta fermo; qui comprano famiglie; ecc."></textarea>
      </div>
      <div>
        <label>‚è≠Ô∏è Prossimo step domani (1 azione)</label>
        <textarea id="next" placeholder="Es: richiamare 3 FORSE e fissare 1 appuntamento."></textarea>
      </div>
    </div>

    <h2 style="margin-top:24px;">Contatti (oggi) ‚Äì obbligatorio classificarli</h2>
    <div class="row">
      <button id="addContact" style="background:var(--primary); color:white; border-color:var(--primary);">
        ‚ûï Aggiungi contatto
      </button>
      <button id="clearContact">
        üóëÔ∏è Svuota contatti
      </button>
    </div>
    
    <!-- Contact Stats -->
    <div class="row" style="margin:16px 0; background:var(--bg); padding:12px; border-radius:10px;">
      <div style="text-align:center;">
        <div style="font-size:24px; font-weight:700; color:var(--primary);" id="contactTotal">0</div>
        <div class="small muted">Totale contatti</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:24px; font-weight:700; color:#166534;" id="contactSi">0</div>
        <div class="small muted">S√å</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:24px; font-weight:700; color:#92400e;" id="contactForse">0</div>
        <div class="small muted">FORSE</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:24px; font-weight:700; color:#991b1b;" id="contactNo">0</div>
        <div class="small muted">NO</div>
      </div>
    </div>
    
    <div style="overflow:auto;">
      <table id="contacts">
        <thead>
          <tr>
            <th style="min-width:160px">Nome</th>
            <th style="min-width:140px">Telefono</th>
            <th style="min-width:240px">Via/Condominio</th>
            <th style="min-width:120px">Classifica</th>
            <th style="min-width:260px">Nota (perch√©)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 style="margin-top:24px;">KPI (oggi)</h2>
    <div class="row">
      <div><label>üë• Persone parlate</label><input id="kPersone" type="number" min="0" value="0" /></div>
      <div><label>üìÖ Appuntamenti fissati</label><input id="kAppFissati" type="number" min="0" value="0" /></div>
      <div><label>‚úÖ Appuntamenti fatti</label><input id="kAppFatti" type="number" min="0" value="0" /></div>
      <div><label>üìù Incarichi firmati</label><input id="kIncarichi" type="number" min="0" value="0" /></div>
      <div><label>üí∞ ‚Ç¨ (oggi)</label><input id="kEuro" type="number" min="0" value="0" /></div>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
(() => {
  // ====== Time helpers ======
  const todayISO = () => {
    const d = new Date();
    const tzOff = d.getTimezoneOffset() * 60000;
    return new Date(d - tzOff).toISOString().slice(0,10);
  };

  const LS_KEY = (d) => `agenda_blocchi_v2:${d}`;

  const BLOCKS = [
    {
      start:"08:30", end:"08:45",
      title:"Accensione: scegli micro-zona + obiettivo",
      do:"Apri agenda, scegli 1 micro-zona (oggi) e scrivi obiettivo pipeline.",
      out:"Zona + obiettivo scritti"
    },
    {
      start:"08:45", end:"09:15",
      title:"Preparazione contatto (brevissima)",
      do:"Prepara 1 frase + 2 domande (parli poco).",
      out:"Script pronto"
    },
    {
      start:"09:15", end:"11:00",
      title:"Blocco ORO 1: zona (osserva + contatta)",
      do:"Giro fisso. Fai contatti. Classifica S√å/FORSE/NO.",
      out:"‚â• 5 contatti scritti"
    },
    {
      start:"11:00", end:"11:30",
      title:"Registrazione (obbligatoria)",
      do:"Scrivi osservazioni + completa contatti.",
      out:"Dati completi"
    },
    {
      start:"11:30", end:"12:30",
      title:"Follow-up 1 (fa cassa)",
      do:"Chiama S√å poi FORSE. Obiettivo: fissare appuntamento o richiamo.",
      out:"Appunt./richiami"
    },
    {
      start:"12:30", end:"13:00",
      title:"Check KPI (secco)",
      do:"Scrivi SOLO numeri. Niente sensazioni.",
      out:"KPI compilati"
    },
    {
      start:"14:30", end:"16:30",
      title:"Blocco ORO 2: esecuzione",
      do:"Se hai appuntamenti: li fai. Se no: torna in zona e fai altri contatti.",
      out:"Appunt. fatti o ‚â•5 contatti"
    },
    {
      start:"16:30", end:"17:30",
      title:"Follow-up 2 (chiude giornata)",
      do:"Richiami programmati + conferme. Fissi domani.",
      out:"Agenda domani"
    },
    {
      start:"17:30", end:"19:00",
      title:"Fascia oro telefono",
      do:"Contatti caldi e segnalazioni. Non spieghi: fissi.",
      out:"Appuntamenti"
    }
  ];

  // ====== UI ======
  const el = {
    pillToday: document.getElementById("pillToday"),
    pillProgress: document.getElementById("pillProgress"),
    pillExport: document.getElementById("pillExport"),
    status: document.getElementById("status"),
    zona: document.getElementById("zona"),
    goal: document.getElementById("goal"),
    obs: document.getElementById("obs"),
    lesson: document.getElementById("lesson"),
    next: document.getElementById("next"),
    kPersone: document.getElementById("kPersone"),
    kAppFissati: document.getElementById("kAppFissati"),
    kAppFatti: document.getElementById("kAppFatti"),
    kIncarichi: document.getElementById("kIncarichi"),
    kEuro: document.getElementById("kEuro"),
    tblBody: document.querySelector("#tbl tbody"),
    btnExportNow: document.getElementById("btnExportNow"),
    btnReset: document.getElementById("btnReset"),
    addContact: document.getElementById("addContact"),
    clearContacts: document.getElementById("clearContact"),
    contactsBody: document.querySelector("#contacts tbody"),
    currentBlock: document.getElementById("currentBlock"),
    progressFill: document.getElementById("progressFill"),
    progressText: document.getElementById("progressText"),
    contactTotal: document.getElementById("contactTotal"),
    contactSi: document.getElementById("contactSi"),
    contactForse: document.getElementById("contactForse"),
    contactNo: document.getElementById("contactNo"),
    toast: document.getElementById("toast")
  };

  const d = todayISO();
  el.pillToday.textContent = `OGGI: ${d}`;

  // ====== Toast ======
  function showToast(message, duration = 3000) {
    el.toast.textContent = message;
    el.toast.className = "toast show";
    setTimeout(() => {
      el.toast.className = "toast";
    }, duration);
  }

  // ====== State ======
  function defaultState() {
    return {
      date: d,
      zona: "",
      goal: "",
      blocks: BLOCKS.map((b, i) => ({ idx:i, done:false, skipped:false, skip_reason:"", note:"" })),
      obs:"", lesson:"", next:"",
      contacts: [],
      kpi: { persone:0, app_fissati:0, app_fatti:0, incarichi:0, euro:0 },
      lastSavedAt: null
    };
  }

  function loadState() {
    const raw = localStorage.getItem(LS_KEY(d));
    if (!raw) return defaultState();
    try { return { ...defaultState(), ...JSON.parse(raw) }; }
    catch { return defaultState(); }
  }

  function saveState(st) {
    st.lastSavedAt = new Date().toISOString();
    localStorage.setItem(LS_KEY(d), JSON.stringify(st));
    el.status.textContent = `Salvato: ${new Date().toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'})}`;
    
    // Update contact stats
    updateContactStats(st);
    
    // Update progress
    updateProgress(st);
    
    return st;
  }

  let st = loadState();

  // ====== Contact Stats ======
  function updateContactStats(st) {
    const total = st.contacts.length;
    const si = st.contacts.filter(c => c.classifica === 'S√å').length;
    const forse = st.contacts.filter(c => c.classifica === 'FORSE').length;
    const no = st.contacts.filter(c => c.classifica === 'NO').length;
    
    el.contactTotal.textContent = total;
    el.contactSi.textContent = si;
    el.contactForse.textContent = forse;
    el.contactNo.textContent = no;
  }

  // ====== Progress ======
  function updateProgress(st) {
    const completed = st.blocks.filter(b => b.done || b.skipped).length;
    const total = BLOCKS.length;
    const percent = Math.round((completed / total) * 100);
    
    el.progressFill.style.width = `${percent}%`;
    el.progressText.textContent = `${percent}% completato`;
    
    // Update progress pill
    el.pillProgress.textContent = `${completed}/${total} blocchi`;
    el.pillProgress.className = "pill " + 
      (completed === total ? "ok" : 
       completed >= total/2 ? "warn" : "bad");
    
    // Update current block info
    updateCurrentBlock();
  }

  function updateCurrentBlock() {
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    
    let currentBlock = null;
    let nextBlock = null;
    
    for (let i = 0; i < BLOCKS.length; i++) {
      const block = BLOCKS[i];
      const startTime = parseInt(block.start.split(':')[0]) * 60 + parseInt(block.start.split(':')[1]);
      const endTime = parseInt(block.end.split(':')[0]) * 60 + parseInt(block.end.split(':')[1]);
      
      if (currentTime >= startTime && currentTime <= endTime) {
        currentBlock = block;
        const blockState = st.blocks[i];
        const status = blockState.done ? '‚úÖ Completato' : 
                      blockState.skipped ? '‚è≠Ô∏è Saltato' : 
                      '‚ñ∂Ô∏è In corso';
        el.currentBlock.textContent = `${block.start}-${block.end}: ${block.title} (${status})`;
        break;
      } else if (currentTime < startTime && !nextBlock) {
        nextBlock = block;
      }
    }
    
    if (!currentBlock) {
      if (nextBlock) {
        el.currentBlock.textContent = `Prossimo: ${nextBlock.start}-${nextBlock.end}: ${nextBlock.title}`;
      } else {
        el.currentBlock.textContent = 'Giornata terminata';
      }
    }
  }

  // ====== Render blocks ======
  function completedCount() {
    return st.blocks.filter(b => b.done || b.skipped).length;
  }

  function isUnlocked(idx) {
    if (idx === 0) return true;
    const prev = st.blocks[idx-1];
    return prev.done || prev.skipped;
  }

  function renderBlocks() {
    el.tblBody.innerHTML = "";
    st.blocks.forEach((b, idx) => {
      const meta = BLOCKS[idx];
      const tr = document.createElement("tr");

      const tdTime = document.createElement("td");
      tdTime.innerHTML = `<div class="mono time-cell">${meta.start}‚Äì${meta.end}</div>`;

      const tdDo = document.createElement("td");
      tdDo.innerHTML = `
        <div class="blockTitle">${meta.title}</div>
        <div class="muted small">${meta.do}</div>
        <label class="small" style="margin-top:8px;">Nota (opzionale)</label>
      `;
      const note = document.createElement("textarea");
      note.style.minHeight = "60px";
      note.style.padding = "8px";
      note.style.fontSize = "13px";
      note.value = b.note || "";
      note.addEventListener("input", () => { b.note = note.value; saveDebounced(); });
      tdDo.appendChild(note);

      const tdOut = document.createElement("td");
      tdOut.innerHTML = `<div class="small"><strong>Output:</strong> ${meta.out}</div>`;

      const tdStatus = document.createElement("td");
      const wrap = document.createElement("div");

      const unlocked = isUnlocked(idx);
      
      // Status badge
      let statusBadge = document.createElement("div");
      statusBadge.className = "status-badge ";
      
      if (b.done) {
        statusBadge.classList.add("status-done");
        statusBadge.textContent = "‚úÖ FATTO";
      } else if (b.skipped) {
        statusBadge.classList.add("status-skip");
        statusBadge.textContent = "‚è≠Ô∏è SALTATO";
      } else {
        statusBadge.classList.add("status-todo");
        statusBadge.textContent = "üìù DA FARE";
      }
      
      wrap.appendChild(statusBadge);

      const lockInfo = document.createElement("div");
      lockInfo.className = "muted small";
      lockInfo.textContent = unlocked ? "‚úÖ Sbloccato" : "üîí Bloccato (completa il precedente)";

      const row1 = document.createElement("div");
      row1.className = "row";
      row1.style.marginTop = "8px";
      row1.style.gap = "8px";

      const chkDone = document.createElement("input");
      chkDone.type = "checkbox";
      chkDone.checked = !!b.done;
      chkDone.disabled = !unlocked;
      chkDone.addEventListener("change", () => {
        if (!unlocked) { 
          showToast("Devi completare il blocco precedente!");
          chkDone.checked = false; 
          return; 
        }
        b.done = chkDone.checked;
        if (b.done) { 
          b.skipped = false; 
          b.skip_reason = ""; 
          showToast(`Blocco "${meta.title}" completato!`);
        }
        renderBlocks(); 
        st = saveState(st);
      });

      const doneLabel = document.createElement("label");
      doneLabel.className = "small";
      doneLabel.style.margin = "0";
      doneLabel.style.display = "flex";
      doneLabel.style.alignItems = "center";
      doneLabel.style.gap = "6px";
      doneLabel.appendChild(chkDone);
      doneLabel.appendChild(document.createTextNode("Fatto"));

      const skipBtn = document.createElement("button");
      skipBtn.textContent = b.skipped ? "Annulla salto" : "Salta";
      skipBtn.className = "small";
      skipBtn.style.padding = "6px 10px";
      skipBtn.disabled = !unlocked;
      skipBtn.addEventListener("click", () => {
        if (!unlocked) {
          showToast("Blocco bloccato!");
          return;
        }
        
        if (!b.skipped) {
          const reason = prompt("Motivo obbligatorio per saltare questo blocco:");
          if (!reason || !reason.trim()) {
            showToast("Devi scrivere un motivo!");
            return;
          }
          b.skipped = true;
          b.skip_reason = reason.trim();
          b.done = false;
          showToast(`Blocco "${meta.title}" saltato`);
        } else {
          // unskip
          b.skipped = false;
          b.skip_reason = "";
          showToast("Salto annullato");
        }
        renderBlocks(); 
        st = saveState(st);
      });

      // lock behavior
      if (!unlocked) {
        tdStatus.classList.add("disabled");
      } else {
        tdStatus.classList.remove("disabled");
      }

      row1.appendChild(doneLabel);
      row1.appendChild(skipBtn);

      wrap.appendChild(lockInfo);

      if (b.skipped && b.skip_reason) {
        const why = document.createElement("div");
        why.className = "muted small";
        why.style.marginTop = "6px";
        why.style.padding = "6px";
        why.style.background = "var(--warn)";
        why.style.borderRadius = "6px";
        why.textContent = "Motivo: " + b.skip_reason;
        wrap.appendChild(why);
      }

      wrap.appendChild(row1);
      tdStatus.appendChild(wrap);

      tr.appendChild(tdTime);
      tr.appendChild(tdDo);
      tr.appendChild(tdOut);
      tr.appendChild(tdStatus);
      el.tblBody.appendChild(tr);
    });
    
    updateProgress(st);
  }

  // ====== Contacts ======
  function renderContacts() {
    el.contactsBody.innerHTML = "";
    st.contacts.forEach((c, idx) => {
      const tr = document.createElement("tr");

      const mkInput = (val, oninput, placeholder = "") => {
        const i = document.createElement("input");
        i.type = "text";
        i.value = val || "";
        i.placeholder = placeholder;
        i.addEventListener("input", oninput);
        i.style.padding = "6px 8px";
        i.style.fontSize = "13px";
        return i;
      };

      const tdNome = document.createElement("td");
      tdNome.appendChild(mkInput(c.nome, (e)=>{ st.contacts[idx].nome = e.target.value; saveDebounced(); }, "Nome"));

      const tdTel = document.createElement("td");
      tdTel.appendChild(mkInput(c.telefono, (e)=>{ st.contacts[idx].telefono = e.target.value; saveDebounced(); }, "333 1234567"));

      const tdVia = document.createElement("td");
      tdVia.appendChild(mkInput(c.via, (e)=>{ st.contacts[idx].via = e.target.value; saveDebounced(); }, "Via e numero"));

      const tdClass = document.createElement("td");
      const sel = document.createElement("select");
      sel.style.padding = "6px 8px";
      sel.style.fontSize = "13px";
      ["S√å","FORSE","NO"].forEach(v => {
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      });
      sel.value = c.classifica || "FORSE";
      sel.addEventListener("change", ()=>{
        st.contacts[idx].classifica = sel.value; 
        saveDebounced();
      });
      
      // Color code based on selection
      if (sel.value === 'S√å') sel.style.background = "var(--ok)";
      else if (sel.value === 'FORSE') sel.style.background = "var(--warn)";
      else if (sel.value === 'NO') sel.style.background = "var(--bad)";
      
      tdClass.appendChild(sel);

      const tdNota = document.createElement("td");
      tdNota.appendChild(mkInput(c.nota, (e)=>{ st.contacts[idx].nota = e.target.value; saveDebounced(); }, "Motivo classificazione..."));

      tr.appendChild(tdNome);
      tr.appendChild(tdTel);
      tr.appendChild(tdVia);
      tr.appendChild(tdClass);
      tr.appendChild(tdNota);
      el.contactsBody.appendChild(tr);
    });
    
    updateContactStats(st);
  }

  el.addContact.addEventListener("click", ()=>{
    st.contacts.push({ nome:"", telefono:"", via:"", classifica:"FORSE", nota:"" });
    renderContacts();
    saveDebounced();
    showToast("Nuovo contatto aggiunto");
  });

  el.clearContacts.addEventListener("click", ()=>{
    if (!confirm("Svuotare i contatti di oggi?")) return;
    st.contacts = [];
    renderContacts();
    saveDebounced();
    showToast("Contatti svuotati");
  });

  // ====== Bind top fields ======
  function bindInputs() {
    el.zona.value = st.zona || "";
    el.goal.value = st.goal || "";
    el.obs.value = st.obs || "";
    el.lesson.value = st.lesson || "";
    el.next.value = st.next || "";
    el.kPersone.value = st.kpi?.persone ?? 0;
    el.kAppFissati.value = st.kpi?.app_fissati ?? 0;
    el.kAppFatti.value = st.kpi?.app_fatti ?? 0;
    el.kIncarichi.value = st.kpi?.incarichi ?? 0;
    el.kEuro.value = st.kpi?.euro ?? 0;

    el.zona.addEventListener("input", ()=>{ st.zona = el.zona.value.trim(); saveDebounced(); });
    el.goal.addEventListener("input", ()=>{ st.goal = el.goal.value.trim(); saveDebounced(); });
    el.obs.addEventListener("input", ()=>{ st.obs = el.obs.value; saveDebounced(); });
    el.lesson.addEventListener("input", ()=>{ st.lesson = el.lesson.value; saveDebounced(); });
    el.next.addEventListener("input", ()=>{ st.next = el.next.value; saveDebounced(); });

    [el.kPersone, el.kAppFissati, el.kAppFatti, el.kIncarichi, el.kEuro].forEach(inp => {
      inp.addEventListener("input", ()=>{
        st.kpi = {
          persone: Number(el.kPersone.value || 0),
          app_fissati: Number(el.kAppFissati.value || 0),
          app_fatti: Number(el.kAppFatti.value || 0),
          incarichi: Number(el.kIncarichi.value || 0),
          euro: Number(el.kEuro.value || 0)
        };
        saveDebounced();
      });
    });
  }

  // ====== Export ======
  function downloadJSON(state, suffix="") {
    const name = `agenda_blocchi_${state.date}${suffix}.json`;
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  function msUntil2100() {
    const now = new Date();
    const t = new Date();
    t.setHours(21,0,0,0);
    if (t <= now) t.setDate(t.getDate()+1);
    return t - now;
  }

  function scheduleAutoExport() {
    setTimeout(()=>{
      const fresh = loadState();
      downloadJSON(fresh, "_autosave");
      el.pillExport.textContent = "‚úÖ Export completato";
      el.pillExport.className = "pill ok";
      showToast("Export automatico completato alle 21:00");
      // re-arm for tomorrow
      scheduleAutoExport();
    }, msUntil2100());
    
    // Update export time display
    function updateExportTime() {
      const now = new Date();
      const exportTime = new Date();
      exportTime.setHours(21,0,0,0);
      if (exportTime < now) exportTime.setDate(exportTime.getDate() + 1);
      
      const diff = exportTime - now;
      const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
      const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      el.pillExport.textContent = `Export 21:00 (tra ${hoursLeft}h ${minutesLeft}m)`;
    }
    
    updateExportTime();
    setInterval(updateExportTime, 60000); // Update every minute
  }

  // ====== Reset ======
  el.btnReset.addEventListener("click", ()=>{
    if (!confirm("Reset oggi: cancello tutti i dati di oggi. Procedere?")) return;
    localStorage.removeItem(LS_KEY(d));
    st = defaultState();
    bindInputs();
    renderBlocks();
    renderContacts();
    st = saveState(st);
    showToast("Giornata resettata");
  });

  el.btnExportNow.addEventListener("click", ()=>{
    const fresh = loadState();
    downloadJSON(fresh);
    el.status.textContent = "Export manuale completato.";
    showToast("Export manuale completato");
  });

  // ====== Debounce save ======
  let tSave = null;
  function saveDebounced() {
    if (tSave) clearTimeout(tSave);
    tSave = setTimeout(()=>{
      st = saveState(st);
    }, 500);
  }

  // ====== Boot ======
  bindInputs();
  renderBlocks();
  renderContacts();
  st = saveState(st);
  scheduleAutoExport();
  
  // Update current block every minute
  setInterval(updateCurrentBlock, 60000);
  updateCurrentBlock();
})();
</script>
</body>
</html>
